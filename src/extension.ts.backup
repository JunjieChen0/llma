import * as vscode from 'vscode';
import * as path from 'path';
import * as fs from 'fs';
import axios from 'axios';

// å…¨å±€çŠ¶æ€æ é¡¹
let statusBarItem: vscode.StatusBarItem;
// ç¼–è¯‘ä¸“ç”¨ç»ˆç«¯
let compilationTerminal: vscode.Terminal | undefined;

// æ‰©å±•æ¿€æ´»å…¥å£
export function activate(context: vscode.ExtensionContext) {
  console.log('=== LLMA å·²æ¿€æ´» ===');

  // 1. åˆå§‹åŒ–çŠ¶æ€æ 
  statusBarItem = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right, 100);
  statusBarItem.command = "llma.toggle"; 
  updateStatusBar(false);
  statusBarItem.show();

  // 2. æ³¨å†Œè¡Œå†…ä»£ç é¢„æµ‹ (Ghost Text)
  const provider = new LLMAInlineCompletionProvider();
  const selector = { pattern: '**' }; 
  const inlineProvider = vscode.languages.registerInlineCompletionItemProvider(selector, provider);

  // 3. æ³¨å†Œä¾§è¾¹æ èŠå¤©çª—å£
  const chatProvider = new LLMAChatProvider(context.extensionUri);
  const chatView = vscode.window.registerWebviewViewProvider("llma.chatView", chatProvider, {
    webviewOptions: { retainContextWhenHidden: true }
  });

  // 4. æ³¨å†Œå‘½ä»¤
  const generateCommand = vscode.commands.registerCommand('llma.aiCodeComplete', async () => {
    await handleExplicitCodeGeneration();
  });

  const toggleCommand = vscode.commands.registerCommand('llma.toggle', () => {
    const config = vscode.workspace.getConfiguration('llma');
    const currentState = config.get<boolean>('enableAutoCompletion');
    config.update('enableAutoCompletion', !currentState, vscode.ConfigurationTarget.Global);
    vscode.window.showInformationMessage(`LLMA è‡ªåŠ¨é¢„æµ‹å·²${!currentState ? 'å¼€å¯' : 'å…³é—­'}`);
  });

  const manualTriggerCommand = vscode.commands.registerCommand('llma.trigger', () => {
    vscode.commands.executeCommand('editor.action.inlineSuggest.trigger');
  });

  // 5. æ³¨å†Œç¼–è¯‘å‘½ä»¤
  const compileCommand = vscode.commands.registerCommand('llma.compileCurrentFile', async () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor) {
      vscode.window.showWarningMessage('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨');
      return;
    }
    await compileFile(editor.document.uri.fsPath, { showDialog: true });
  });

  const compileWithOptionsCommand = vscode.commands.registerCommand('llma.compileWithOptions', async () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor) {
      vscode.window.showWarningMessage('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨');
      return;
    }
    await showCompilationOptions(editor.document.uri.fsPath);
  });

  // 6. ç›‘å¬é…ç½®å˜åŒ–
  const configListener = vscode.workspace.onDidChangeConfiguration(e => {
    if (e.affectsConfiguration('llma')) {
      updateStatusBar(false);
    }
  });

  context.subscriptions.push(
    statusBarItem,
    inlineProvider,
    chatView,
    generateCommand,
    toggleCommand,
    manualTriggerCommand,
    compileCommand,
    compileWithOptionsCommand,
    configListener
  );
}

export function deactivate() {
  if (compilationTerminal) {
    compilationTerminal.dispose();
  }
  console.log('LLMA å·²åœç”¨');
}

/**
 * === ç¼–è¯‘æ ¸å¿ƒåŠŸèƒ½ ===
 */

async function compileFile(filePath: string, options: { 
  showDialog?: boolean;
  customCommand?: string;
  outputPath?: string;
  args?: string[];
} = {}) {
  try {
    const config = vscode.workspace.getConfiguration('llma');
    const compilers = config.get<any>('compilation.compilers') || {};
    const defaultOutputDir = config.get<string>('compilation.defaultOutputDir') || 'build';
    
    const fileExt = path.extname(filePath).toLowerCase();
    const fileName = path.basename(filePath);
    const fileNameWithoutExt = path.basename(filePath, fileExt);
    const fileDir = path.dirname(filePath);
    
    // è·å–æ–‡ä»¶è¯­è¨€
    const language = getLanguageFromExtension(fileExt);
    
    if (!language) {
      vscode.window.showErrorMessage(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${fileExt}`);
      return;
    }
    
    // ç¡®å®šè¾“å‡ºç›®å½•
    let outputDir: string;
    if (options.outputPath) {
        outputDir = path.dirname(options.outputPath);
    } else {
        outputDir = path.join(fileDir, defaultOutputDir);
    }
    
    // è·å–å¯æ‰§è¡Œæ–‡ä»¶å
    const executableName = getExecutableName(fileNameWithoutExt, language);
    const outputPath = options.outputPath || path.join(outputDir, executableName);
    
    // è·å–ç¼–è¯‘å‘½ä»¤
    let compileCommand = options.customCommand || compilers[language];
    
    if (!compileCommand) {
      vscode.window.showErrorMessage(`æœªé…ç½® ${language} è¯­è¨€çš„ç¼–è¯‘å‘½ä»¤`);
      return;
    }
    
    // å¯¹äº Javaï¼Œé»˜è®¤ä½¿ç”¨ -d å‚æ•°æŒ‡å®šè¾“å‡ºç›®å½•ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰å‘½ä»¤ï¼‰
    if (language === 'java' && !options.customCommand) {
        compileCommand = compilers['java'] || `javac -d \"{outputDir}\" \"{file}\"`;
    }
    
    // æ›¿æ¢å ä½ç¬¦
    compileCommand = compileCommand
      .replace(/{file}/g, `"${filePath}"`)
      .replace(/{executable}/g, `"${outputPath}"`)
      .replace(/{fileDir}/g, `"${fileDir}"`)
      .replace(/{fileName}/g, fileName)
      .replace(/{fileNameWithoutExt}/g, fileNameWithoutExt)
      .replace(/{outputDir}/g, `"${outputDir}"`);
    
    // æ·»åŠ é¢å¤–å‚æ•°
    if (options.args && options.args.length > 0) {
      compileCommand += ` ${options.args.join(' ')}`;
    }
    
    // åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }
    
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    if (options.showDialog) {
      const selection = await vscode.window.showInformationMessage(
        `ç¼–è¯‘ ${fileName}?`,
        {
          modal: true,
          detail: `å‘½ä»¤: ${compileCommand}\nè¾“å‡ºç›®å½•: ${outputDir}\nè¾“å‡ºæ–‡ä»¶: ${executableName}`
        },
        "âœ… ç¼–è¯‘",
        "âš™ï¸ è‡ªå®šä¹‰å‚æ•°",
        "âŒ å–æ¶ˆ"
      );
      
      if (selection === "âŒ å–æ¶ˆ") {
        return;
      }
      
      if (selection === "âš™ï¸ è‡ªå®šä¹‰å‚æ•°") {
        await showCompilationOptions(filePath);
        return;
      }
    }
    
    await executeCompilationCommand(compileCommand, filePath, outputPath, language, fileNameWithoutExt, outputDir);
    
  } catch (error: any) {
    vscode.window.showErrorMessage(`ç¼–è¯‘å¤±è´¥: ${error.message}`);
  }
}

async function showCompilationOptions(filePath: string) {
  const config = vscode.workspace.getConfiguration('llma');
  const compilers = config.get<any>('compilation.compilers') || {};
  const fileExt = path.extname(filePath).toLowerCase();
  const language = getLanguageFromExtension(fileExt);
  
  if (!language) {
    vscode.window.showErrorMessage(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${fileExt}`);
    return;
  }
  
  const defaultCommand = compilers[language] || '';
  
  const customCommand = await vscode.window.showInputBox({
    prompt: `è¯·è¾“å…¥ ${language} ç¼–è¯‘å‘½ä»¤ï¼ˆä½¿ç”¨ {file}ã€{executable}ã€{outputDir} ç­‰å ä½ç¬¦ï¼‰`,
    value: defaultCommand,
    placeHolder: `ä¾‹å¦‚: gcc "{file}" -o "{executable}" -Wall æˆ– javac -d "{outputDir}" "{file}"`
  });
  
  if (customCommand === undefined) {
    return;
  }
  
  const additionalArgs = await vscode.window.showInputBox({
    prompt: 'è¯·è¾“å…¥é¢å¤–å‚æ•°ï¼ˆå¯é€‰ï¼‰',
    placeHolder: 'ä¾‹å¦‚: -O2 -g -I./include'
  });
  
  const outputPath = await vscode.window.showSaveDialog({
    defaultUri: vscode.Uri.file(path.join(path.dirname(filePath), 'build', 
      getExecutableName(path.basename(filePath, fileExt), language))),
    filters: {
      'å¯æ‰§è¡Œæ–‡ä»¶': ['exe', 'out', 'class', ''],
      'æ‰€æœ‰æ–‡ä»¶': ['*']
    }
  });
  
  await compileFile(filePath, {
    customCommand,
    outputPath: outputPath?.fsPath,
    args: additionalArgs && additionalArgs.trim() ? additionalArgs.split(' ') : []
  });
}

async function executeCompilationCommand(command: string, filePath: string, outputPath: string, language: string, fileNameWithoutExt: string, outputDir: string) {
  if (!compilationTerminal) {
    compilationTerminal = vscode.window.createTerminal({
      name: 'LLMA Compilation',
      shellPath: getShellPath()
    });
  }
  
  compilationTerminal.show();
  compilationTerminal.sendText('clear', true);
  compilationTerminal.sendText(`echo "=== LLMA ç¼–è¯‘å¼€å§‹ ==="`);
  compilationTerminal.sendText(`echo "æ–‡ä»¶: ${path.basename(filePath)}"`);
  compilationTerminal.sendText(`echo "å‘½ä»¤: ${command}"`);
  compilationTerminal.sendText(`echo "è¾“å‡ºç›®å½•: ${outputDir}"`);
  compilationTerminal.sendText(`echo ""`);
  
  const fileDir = path.dirname(filePath);
  compilationTerminal.sendText(getChangeDirectoryCommand(fileDir));
  compilationTerminal.sendText(command);
  compilationTerminal.sendText(`echo ""`);
  compilationTerminal.sendText(`echo "=== ç¼–è¯‘è¿‡ç¨‹ç»“æŸ (è¯·æ£€æŸ¥ä¸Šæ–¹æŠ¥é”™) ==="`);
  
  setTimeout(async () => {
    if (language === 'python') {
      compilationTerminal?.sendText(`echo "âœ… Python è¯­æ³•æ£€æŸ¥å®Œæˆ"`);
      const selection = await vscode.window.showInformationMessage(
        `Python è¯­æ³•æ£€æŸ¥å®Œæˆï¼æ˜¯å¦è¿è¡Œç¨‹åºï¼Ÿ`,
        "â–¶ï¸ è¿è¡Œ",
        "âŒ å…³é—­"
      );
      if (selection === "â–¶ï¸ è¿è¡Œ") {
        await runExecutable(filePath, language);
      }
    }
    else if (language === 'java') {
      const className = fileNameWithoutExt + '.class';
      const classFilePath = path.join(outputDir, className);
      
      if (fs.existsSync(classFilePath)) {
        compilationTerminal?.sendText(`echo "âœ… Java ç¼–è¯‘æˆåŠŸï¼Œç”Ÿæˆ ${className}"`);
        const selection = await vscode.window.showInformationMessage(
          `Java ç¼–è¯‘æˆåŠŸï¼æ˜¯å¦è¿è¡Œç¨‹åºï¼Ÿ`,
          "â–¶ï¸ è¿è¡Œ",
          "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º",
          "âŒ å…³é—­"
        );
        if (selection === "â–¶ï¸ è¿è¡Œ") {
          await runExecutable(classFilePath, language);
        } else if (selection === "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º") {
          vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(outputDir));
        }
      } else {
        compilationTerminal?.sendText(`echo "âš ï¸ æœªæ£€æµ‹åˆ°ç”Ÿæˆçš„ .class æ–‡ä»¶"`);
      }
    }
    else if (language === 'javascript') {
      compilationTerminal?.sendText(`echo "âœ… JavaScript è¯­æ³•æ£€æŸ¥å®Œæˆ"`);
      const selection = await vscode.window.showInformationMessage(
        `JavaScript è¯­æ³•æ£€æŸ¥å®Œæˆï¼æ˜¯å¦è¿è¡Œç¨‹åºï¼Ÿ`,
        "â–¶ï¸ è¿è¡Œ",
        "âŒ å…³é—­"
      );
      if (selection === "â–¶ï¸ è¿è¡Œ") {
        await runExecutable(filePath, language);
      }
    }
    else if (language === 'typescript') {
      compilationTerminal?.sendText(`echo "âœ… TypeScript ç±»å‹æ£€æŸ¥å®Œæˆ"`);
      const selection = await vscode.window.showInformationMessage(
        `TypeScript ç±»å‹æ£€æŸ¥å®Œæˆï¼`,
        "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤ºè¾“å‡ºç›®å½•",
        "âŒ å…³é—­"
      );
      if (selection === "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤ºè¾“å‡ºç›®å½•") {
        vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(outputDir));
      }
    }
    else {
      if (fs.existsSync(outputPath)) {
        compilationTerminal?.sendText(`echo "âœ… æ£€æµ‹åˆ°è¾“å‡ºæ–‡ä»¶: ${outputPath}"`);
        const isExecutable = ['c', 'cpp', 'rust', 'go', 'cangjie'].includes(language);
        const selection = await vscode.window.showInformationMessage(
          `ç¼–è¯‘å®Œæˆï¼${isExecutable ? 'æ˜¯å¦è¿è¡Œï¼Ÿ' : 'æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶ï¼Ÿ'}`,
          isExecutable ? "â–¶ï¸ è¿è¡Œ" : "ğŸ“ æŸ¥çœ‹",
          "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º",
          "âŒ å…³é—­"
        );
        if (selection === "â–¶ï¸ è¿è¡Œ") {
          await runExecutable(outputPath, language);
        } else if (selection === "ğŸ“ æŸ¥çœ‹" || selection === "ğŸ“ åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º") {
          vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(outputPath));
        }
      } else {
        compilationTerminal?.sendText(`echo "âš ï¸ æœªæ£€æµ‹åˆ°æ–°ç”Ÿæˆçš„æ–‡ä»¶"`);
      }
    }
  }, 1500);
}

async function runExecutable(executablePath: string, language: string) {
  const ext = path.extname(executablePath);
  const baseName = path.basename(executablePath);
  const terminalName = `LLMA Runner - ${baseName}`;
  
  const runTerminal = vscode.window.createTerminal({
    name: terminalName,
    shellPath: getShellPath()
  });
  
  runTerminal.show();
  
  let runCommand = '';
  const execDir = path.dirname(executablePath);
  runTerminal.sendText(getChangeDirectoryCommand(execDir));
  
  if (ext === '.class' || language === 'java') {
    const className = path.basename(executablePath, '.class');
    runCommand = `java ${className}`;
  } else if (ext === '.py' || language === 'python') {
    const pythonInfo = await getPythonRunCommand(executablePath);
    if (process.platform === 'win32') {
      runCommand = `& '${pythonInfo.interpreter}' '${baseName}'`;
    } else {
      runCommand = `"${pythonInfo.interpreter}" "${baseName}"`;
    }
  } else if (ext === '.js' || language === 'javascript') {
    runCommand = `node "${baseName}"`;
  } else {
    if (process.platform === 'win32') {
      runCommand = `& ".\\${baseName}"`;
    } else {
      runCommand = `"./${baseName}"`;
    }
  }
  
  runTerminal.sendText(runCommand);
  runTerminal.sendText(`echo ""`);
  if (process.platform === 'win32') {
    runTerminal.sendText('pause');
  } else {
    runTerminal.sendText('read -p "æŒ‰å›è½¦é”®å…³é—­..."');
  }
}

function getLanguageFromExtension(ext: string): string | null {
  const languageMap: { [key: string]: string } = {
    '.c': 'c',
    '.cpp': 'cpp',
    '.cc': 'cpp',
    '.cxx': 'cpp',
    '.java': 'java',
    '.class': 'java',
    '.jar': 'java',
    '.py': 'python',
    '.js': 'javascript',
    '.ts': 'typescript',
    '.rs': 'rust',
    '.go': 'go',
    '.cs': 'csharp',
    '.php': 'php',
    '.rb': 'ruby',
    '.swift': 'swift',
    '.m': 'objective-c',
    '.cj': 'cangjie'
  };
  return languageMap[ext] || null;
}

function getExecutableName(baseName: string, language: string): string {
  if (process.platform === 'win32') {
    if (language === 'java') {
      return `${baseName}.class`;
    }
    return `${baseName}.exe`;
  }
  if (['python', 'javascript', 'ruby', 'php'].includes(language)) {
    return baseName;
  }
  if (language === 'java') {
    return `${baseName}.class`;
  }
  return baseName;
}

function getShellPath(): string {
  if (process.platform === 'win32') {
    return process.env.PSModulePath ? 'powershell.exe' : (process.env.COMSPEC || 'cmd.exe');
  }
  return process.env.SHELL || '/bin/bash';
}

function getChangeDirectoryCommand(dirPath: string): string {
  const normalizedPath = dirPath.replace(/\\/g, '\\\\');
  
  if (process.platform === 'win32') {
    return process.env.PSModulePath 
      ? `Set-Location -Path '${normalizedPath}'` 
      : `cd /d "${normalizedPath}"`;
  } else {
    return `cd "${normalizedPath}"`;
  }
}

/**
 * === Python è§£é‡Šå™¨ç®¡ç†åŠŸèƒ½ ===
 */

interface PythonInterpreterInfo {
  path: string;
  version?: string;
  isVirtualEnv?: boolean;
  virtualEnvPath?: string;
}

function getPythonInterpreterPath(): string | undefined {
  const config = vscode.workspace.getConfiguration('llma');
  const interpreterPath = config.get<string>('python.interpreterPath');
  
  if (interpreterPath && interpreterPath.trim() !== '') {
    if (path.isAbsolute(interpreterPath)) {
      return interpreterPath;
    }
    const workspaceFolders = vscode.workspace.workspaceFolders;
    if (workspaceFolders && workspaceFolders.length > 0) {
      const absolutePath = path.join(workspaceFolders[0].uri.fsPath, interpreterPath);
      if (fs.existsSync(absolutePath)) {
        return absolutePath;
      }
    }
  }
  
  return undefined;
}

function detectPythonInterpreter(): string {
  const config = vscode.workspace.getConfiguration('llma');
  const preferredCommand = config.get<string>('python.preferredCommand') || 'auto';
  
  const configuredPath = getPythonInterpreterPath();
  if (configuredPath) {
    return configuredPath;
  }
  
  if (preferredCommand !== 'auto') {
    return preferredCommand;
  }
  
  if (process.platform === 'win32') {
    return 'py';
  } else {
    return 'python3';
  }
}

function detectVirtualEnv(filePath: string): string | undefined {
  const config = vscode.workspace.getConfiguration('llma');
  const autoDetect = config.get<boolean>('python.autoDetectVirtualEnv');
  
  if (!autoDetect) {
    return undefined;
  }
  
  const fileDir = path.dirname(filePath);
  
  const venvDirs = [
    'venv',
    '.venv',
    'env',
    '.env',
    'virtualenv',
    '.virtualenv'
  ];
  
  let currentDir = fileDir;
  let maxDepth = 5;
  
  while (maxDepth-- > 0 && currentDir !== path.dirname(currentDir)) {
    for (const venvDir of venvDirs) {
      const venvPath = path.join(currentDir, venvDir);
      
      if (fs.existsSync(venvPath)) {
        let pythonPath: string;
        
        if (process.platform === 'win32') {
          pythonPath = path.join(venvPath, 'Scripts', 'python.exe');
        } else {
          pythonPath = path.join(venvPath, 'bin', 'python');
        }
        
        if (fs.existsSync(pythonPath)) {
          return pythonPath;
        }
      }
    }
    
    currentDir = path.dirname(currentDir);
  }
  
  return undefined;
}

async function checkPythonVersion(pythonPath: string): Promise<string | undefined> {
  try {
    const { exec } = require('child_process');
    
    return new Promise((resolve) => {
      exec(`"${pythonPath}" --version`, (error: any, stdout: string, stderr: string) => {
        if (error) {
          resolve(undefined);
          return;
        }
        
        const versionOutput = (stdout || stderr).trim();
        const versionMatch = versionOutput.match(/Python\s+(\d+\.\d+\.\d+)/);
        
        if (versionMatch) {
          resolve(versionMatch[1]);
        } else {
          resolve(undefined);
        }
      });
    });
  } catch (error) {
    return undefined;
  }
}

async function getPythonRunCommand(filePath: string): Promise<{ command: string; interpreter: string; version?: string }> {
  const config = vscode.workspace.getConfiguration('llma');
  const versionCheck = config.get<boolean>('python.versionCheck');
  
  const venvPython = detectVirtualEnv(filePath);
  const configuredPython = getPythonInterpreterPath();
  const autoDetectedPython = detectPythonInterpreter();
  
  let pythonInterpreter = venvPython || configuredPython || autoDetectedPython;
  
  let version: string | undefined;
  if (versionCheck) {
    version = await checkPythonVersion(pythonInterpreter);
  }
  
  const baseName = path.basename(filePath);
  let runCommand: string;
  
  if (process.platform === 'win32') {
    runCommand = `"${pythonInterpreter}" "${baseName}"`;
  } else {
    runCommand = `"${pythonInterpreter}" "${baseName}"`;
  }
  
  return {
    command: runCommand,
    interpreter: pythonInterpreter,
    version
  };
}

function showPythonInfo(interpreter: string, version?: string, isVirtual?: boolean) {
  const info = `Python è§£é‡Šå™¨: ${interpreter}`;
  const versionInfo = version ? `\nç‰ˆæœ¬: ${version}` : '';
  const venvInfo = isVirtual ? '\n(è™šæ‹Ÿç¯å¢ƒ)' : '';
  
  vscode.window.showInformationMessage(info + versionInfo + venvInfo);
}

/**
 * === ä¾§è¾¹æ èŠå¤©è§†å›¾æä¾›è€… ===
 */
class LLMAChatProvider implements vscode.WebviewViewProvider {
  private _view?: vscode.WebviewView;

  constructor(private readonly _extensionUri: vscode.Uri) {}

  public resolveWebviewView(
    webviewView: vscode.WebviewView,
    context: vscode.WebviewViewResolveContext,
    _token: vscode.CancellationToken,
  ) {
    this._view = webviewView;

    webviewView.webview.options = {
      enableScripts: true,
      localResourceRoots: [this._extensionUri]
    };

    webviewView.webview.html = this._getHtmlForWebview(webviewView.webview);

    vscode.window.onDidChangeTextEditorSelection(e => {
      if (this._view && e.textEditor === vscode.window.activeTextEditor) {
        this.updateContextStatus(e.textEditor);
      }
    });

    webviewView.webview.onDidReceiveMessage(async (data) => {
      switch (data.type) {
        case 'sendMessage':
          await this.handleUserMessage(data.text, data.history, data.model, data.mode, data.files);
          break;
        case 'applyFileChange':
          await this.handleApplyFileChange(data.filepath, data.content);
          break;
        case 'compileCurrentFile':
           await vscode.commands.executeCommand('llma.compileCurrentFile');
           break;
        case 'refreshContext':
           if (vscode.window.activeTextEditor) {
             this.updateContextStatus(vscode.window.activeTextEditor);
           }
           break;
        case 'selectContextFiles':
           await this.handleSelectContextFiles();
           break;
        case 'getSettings':
           await this.sendSettingsToWebview();
           break;
        case 'saveSettings':
           await this.handleSaveSettings(data.settings);
           break;
        case 'log':
           console.log('Webview Log:', data.message);
           break;
      }
    });
  }

  private async handleApplyFileChange(filepath: string, content: string) {
    const workspaceFolders = vscode.workspace.workspaceFolders;
    if (!workspaceFolders) {
      vscode.window.showErrorMessage('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå·¥ä½œåŒºæ–‡ä»¶å¤¹');
      return;
    }

    let targetUri: vscode.Uri;
    if (path.isAbsolute(filepath)) {
      targetUri = vscode.Uri.file(filepath);
    } else {
      targetUri = vscode.Uri.joinPath(workspaceFolders[0].uri, filepath);
    }

    let fileExists = false;
    try {
      await vscode.workspace.fs.stat(targetUri);
      fileExists = true;
    } catch {
      fileExists = false;
    }

    if (fileExists) {
      try {
        const doc = await vscode.workspace.openTextDocument(targetUri);
        await vscode.window.showTextDocument(doc, { preview: false });
        
        const fullRange = new vscode.Range(
          doc.positionAt(0),
          doc.positionAt(doc.getText().length)
        );

        const edit = new vscode.WorkspaceEdit();
        edit.replace(targetUri, fullRange, content);

        const applied = await vscode.workspace.applyEdit(edit);
        
        if (applied) {
          const selection = await vscode.window.showInformationMessage(
            `LLMA Agent å·²ä¿®æ”¹æ–‡ä»¶: ${path.basename(filepath)}`,
            { modal: true, detail: "ä¿®æ”¹å·²åº”ç”¨åˆ°ç¼–è¾‘å™¨ç¼“å†²åŒºã€‚è¯·å®¡æŸ¥ä»£ç ï¼Œé€‰æ‹©æ˜¯å¦ä¿ç•™æ›´æ”¹ã€‚" },
            "ğŸ’¾ æ¥å—å¹¶ä¿å­˜", 
            "â†©ï¸ æ’¤é”€æ›´æ”¹"
          );

          if (selection === "ğŸ’¾ æ¥å—å¹¶ä¿å­˜") {
            await doc.save();
            vscode.window.setStatusBarMessage(`å·²ä¿å­˜ ${path.basename(filepath)}`, 3000);
          } else {
            await vscode.commands.executeCommand('undo');
            vscode.window.setStatusBarMessage(`å·²æ’¤é”€æ›´æ”¹`, 3000);
          }
        } else {
          vscode.window.showErrorMessage('æ— æ³•åº”ç”¨æ›´æ”¹ï¼Œæ–‡ä»¶å¯èƒ½è¢«é”å®šæˆ–åªè¯»ã€‚');
        }
      } catch (e: any) {
        vscode.window.showErrorMessage(`ä¿®æ”¹æ–‡ä»¶æ—¶å‡ºé”™: ${e.message}`);
      }

    } else {
      const selection = await vscode.window.showInformationMessage(
        `LLMA Agent è¯·æ±‚åˆ›å»ºæ–°æ–‡ä»¶: ${path.basename(filepath)}`,
        { modal: true, detail: `å°†åœ¨è·¯å¾„ ${targetUri.fsPath} åˆ›å»ºæ–‡ä»¶ã€‚` },
        "âœ… ç¡®è®¤åˆ›å»º",
        "âŒ å–æ¶ˆ"
      );

      if (selection === "âœ… ç¡®è®¤åˆ›å»º") {
        try {
          const edit = new vscode.WorkspaceEdit();
          edit.createFile(targetUri, { ignoreIfExists: true });
          edit.insert(targetUri, new vscode.Position(0, 0), content);
          
          const applied = await vscode.workspace.applyEdit(edit);
          if (applied) {
             const doc = await vscode.workspace.openTextDocument(targetUri);
             await vscode.window.showTextDocument(doc);
             await doc.save();
             vscode.window.setStatusBarMessage(`å·²åˆ›å»ºå¹¶ä¿å­˜: ${path.basename(filepath)}`, 3000);
          } else {
             vscode.window.showErrorMessage(`åˆ›å»ºæ–‡ä»¶å¤±è´¥`);
          }
        } catch (e: any) {
          vscode.window.showErrorMessage(`åˆ›å»ºå¤±è´¥: ${e.message}`);
        }
      }
    }
  }

  private async handleSelectContextFiles() {
    const uris = await vscode.window.showOpenDialog({
      canSelectMany: true,
      openLabel: 'æ·»åŠ åˆ°ä¸Šä¸‹æ–‡',
      title: 'é€‰æ‹©è¦è®© AI å‚è€ƒçš„æ–‡ä»¶'
    });

    if (uris && uris.length > 0) {
      this._view?.webview.postMessage({
        type: 'filesSelected',
        files: uris.map(u => ({ name: path.basename(u.fsPath), path: u.fsPath }))
      });
    }
  }

  private async sendSettingsToWebview() {
    const config = vscode.workspace.getConfiguration('llma');
    this._view?.webview.postMessage({
      type: 'updateSettings',
      settings: {
        deepseekApiKey: config.get('deepseekApiKey') || '',
        qwenApiKey: config.get('qwenApiKey') || '',
        doubanApiKey: config.get('doubanApiKey') || '',
        doubanModel: config.get('doubanModel') || '',
        zhipuApiKey: config.get('zhipuApiKey') || '',
        localModelEnabled: config.get('localModel.enabled') || false,
        localModelBaseUrl: config.get('localModel.baseUrl') || 'http://localhost:11434/v1',
        localModelName: config.get('localModel.modelName') || 'llama3',
        localModelTimeout: config.get('localModel.timeout') || 120000,
        enableWebSearch: config.get('enableWebSearch') || false,
        webSearchEngine: config.get('webSearchEngine') || 'bing',
        bingApiKey: config.get('bingApiKey') || '',
        baiduApiKey: config.get('baiduApiKey') || '',
        googleApiKey: config.get('googleApiKey') || '',
        googleSearchEngineId: config.get('googleSearchEngineId') || ''
      }
    });
  }

  private async handleSaveSettings(settings: any) {
    const config = vscode.workspace.getConfiguration('llma');
    try {
      if (settings.deepseekApiKey !== undefined) {
        await config.update('deepseekApiKey', settings.deepseekApiKey, vscode.ConfigurationTarget.Global);
      }
      if (settings.qwenApiKey !== undefined) {
        await config.update('qwenApiKey', settings.qwenApiKey, vscode.ConfigurationTarget.Global);
      }
      if (settings.doubanApiKey !== undefined) {
        await config.update('doubanApiKey', settings.doubanApiKey, vscode.ConfigurationTarget.Global);
      }
      if (settings.doubanModel !== undefined) {
        await config.update('doubanModel', settings.doubanModel, vscode.ConfigurationTarget.Global);
      }
      if (settings.zhipuApiKey !== undefined) {
        await config.update('zhipuApiKey', settings.zhipuApiKey, vscode.ConfigurationTarget.Global);
      }
      
      if (settings.localModelEnabled !== undefined) {
        await config.update('localModel.enabled', settings.localModelEnabled, vscode.ConfigurationTarget.Global);
      }
      if (settings.localModelBaseUrl !== undefined) {
        await config.update('localModel.baseUrl', settings.localModelBaseUrl, vscode.ConfigurationTarget.Global);
      }
      if (settings.localModelName !== undefined) {
        await config.update('localModel.modelName', settings.localModelName, vscode.ConfigurationTarget.Global);
      }
      if (settings.localModelTimeout !== undefined) {
        await config.update('localModel.timeout', settings.localModelTimeout, vscode.ConfigurationTarget.Global);
      }
      
      if (settings.enableWebSearch !== undefined) {
        await config.update('enableWebSearch', settings.enableWebSearch, vscode.ConfigurationTarget.Global);
      }
      if (settings.bingApiKey !== undefined) {
        await config.update('bingApiKey', settings.bingApiKey, vscode.ConfigurationTarget.Global);
      }
      
      vscode.window.showInformationMessage('é…ç½®å·²æ›´æ–°ï¼');
      await this.sendSettingsToWebview();
    } catch (e: any) {
      vscode.window.showErrorMessage(`é…ç½®ä¿å­˜å¤±è´¥: ${e.message}`);
    }
  }

  private updateContextStatus(editor: vscode.TextEditor) {
     const fileName = path.basename(editor.document.fileName);
     const lineCount = editor.selection.isEmpty ? 0 : editor.selection.end.line - editor.selection.start.line + 1;
     const contextInfo = editor.selection.isEmpty 
        ? `å½“å‰ç¼–è¾‘å™¨: ${fileName}` 
        : `é€‰ä¸­ä»£ç : ${fileName} (${lineCount} è¡Œ)`;
     
     this._view?.webview.postMessage({ type: 'updateContextInfo', text: contextInfo });
  }

  private async handleUserMessage(userText: string, history: any[], selectedModel: string, mode: 'chat' | 'agent', attachedFiles: string[]) {
  if (!this._view) {
    return;
  }

  const editor = vscode.window.activeTextEditor;
  let contextPrompt = "";
  const maxContextLength = mode === 'agent' ? 8000 : 4000;

  if (editor) {
    const document = editor.document;
    const selection = editor.selection;
    const fileName = path.basename(document.fileName);
    const relativePath = vscode.workspace.asRelativePath(document.uri);
    const language = document.languageId;
    
    let codeContext = "";
    
    if (!selection.isEmpty) {
      codeContext = document.getText(selection);
    } else {
      const cursorLine = selection.active.line;
      const startLine = Math.max(0, cursorLine - 200);
      const endLine = Math.min(document.lineCount - 1, cursorLine + 50);
      const range = new vscode.Range(startLine, 0, endLine, document.lineAt(endLine).range.end.character);
      codeContext = document.getText(range);
    }
    
    if (codeContext.length > maxContextLength) {
      codeContext = codeContext.substring(0, maxContextLength) + "\n... (truncated)";
    }

    contextPrompt += `\n\n[Active File: ${relativePath}]\n\`\`\`${language}\n${codeContext}\n\`\`\`\n`;
  }

  if (attachedFiles && attachedFiles.length > 0) {
    contextPrompt += `\n\n=== User Attached Files ===\n`;
    for (const filePath of attachedFiles) {
      try {
        const content = await fs.promises.readFile(filePath, 'utf-8');
        const truncatedContent = content.length > 10000 ? content.substring(0, 10000) + "\n... (File too large, truncated)" : content;
        const relPath = vscode.workspace.asRelativePath(filePath);
        contextPrompt += `\n[File: ${relPath}]\n\`\`\`\n${truncatedContent}\n\`\`\`\n`;
      } catch (e) {
        contextPrompt += `\n[File: ${path.basename(filePath)}] (Error reading file)\n`;
      }
    }
  }

  const config = vscode.workspace.getConfiguration('llma');
  const model = selectedModel || config.get<string>('currentModel') || 'deepseek';
  
  if (model === 'local') {
    const localEnabled = config.get<boolean>('localModel.enabled', false);
    if (!localEnabled) {
      this._view.webview.postMessage({ 
        type: 'addResponse', 
        text: `âš ï¸ æœ¬åœ°æ¨¡å‹æœªå¯ç”¨\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¯ç”¨:\n1. æ‰“å¼€ VS Code è®¾ç½® (Ctrl+,)\n2. æœç´¢ "LLMA Pro é…ç½®"\n3. æ‰¾åˆ° "llma.localModel.enabled" å¹¶å¯ç”¨\n4. é…ç½®æœ¬åœ°æ¨¡å‹æœåŠ¡åœ°å€ (é»˜è®¤: http://localhost:11434/v1)\n5. é…ç½®æ¨¡å‹åç§° (å¦‚: llama3, qwen2, codellama)\n\nç¡®ä¿æœ¬åœ°æœåŠ¡(å¦‚ Ollama)å·²å¯åŠ¨ã€‚` 
      });
      return;
    }
    
    const baseUrl = config.get<string>('localModel.baseUrl') || 'http://localhost:11434/v1';
    const modelName = config.get<string>('localModel.modelName') || 'llama3';
    console.log(`[LLMA] ä½¿ç”¨æœ¬åœ°æ¨¡å‹: ${modelName}, URL: ${baseUrl}`);
  }
  
  const apiKey = getApiKey(config, model);

  if (model !== 'local' && !apiKey) {
    this._view.webview.postMessage({ type: 'addResponse', text: `âš ï¸ è¯·ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å›¾æ ‡é…ç½® ${model} çš„ API Key` });
    return;
  }
  
  // æ£€æŸ¥è±†åŒ…æ¨¡å‹IDæ˜¯å¦é…ç½®
  if (model === 'douban') {
    const doubanModel = config.get<string>('doubanModel');
    if (!doubanModel) {
      this._view.webview.postMessage({ 
        type: 'addResponse', 
        text: `âš ï¸ è±†åŒ…(Volcengine) éœ€è¦é…ç½® Endpoint IDã€‚\nè¯·ç‚¹å‡»è®¾ç½®å›¾æ ‡ âš™ï¸ï¼Œåœ¨"è±†åŒ… Endpoint ID"ä¸­è¾“å…¥æ¥å…¥ç‚¹ID (æ ¼å¼å¦‚ ep-2024...)ã€‚` 
      });
      return;
    }
  }

  try {
    // === è”ç½‘æœç´¢åŠŸèƒ½ ===
    let webSearchResults = '';
    const enableWebSearch = config.get<boolean>('enableWebSearch', false);
    const bingApiKey = config.get<string>('bingApiKey', '');
    
    // å¦‚æœå¯ç”¨äº†è”ç½‘æœç´¢ï¼Œä¸”æ£€æµ‹åˆ°éœ€è¦æœç´¢ï¼Œä¸”æœ‰ API Key
    if (enableWebSearch && bingApiKey && needsWebSearch(userText)) {
      this._view.webview.postMessage({ type: 'addResponse', text: 'ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œä¿¡æ¯...' });
      
      try {
        const results = await searchWeb(userText, bingApiKey, 5);
        webSearchResults = formatSearchResults(results);
        console.log(`[LLMA] æœç´¢åˆ° ${results.length} æ¡ç»“æœ`);
      } catch (searchError: any) {
        console.error('[LLMA] æœç´¢å¤±è´¥:', searchError.message);
        webSearchResults = `\n\nâš ï¸ ç½‘ç»œæœç´¢å¤±è´¥: ${searchError.message}\n`;
      }
    }

    let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ VS Code ç¼–ç¨‹åŠ©æ‰‹ã€‚è¯·ä½¿ç”¨ä¸­æ–‡å›ç­”ã€‚å¦‚æœæ¶‰åŠä»£ç ç”Ÿæˆï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ã€‚';
    
    if (mode === 'agent') {
      systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé«˜çº§ä»£ç  Agentï¼Œå…·å¤‡ç›´æ¥ä¿®æ”¹ã€åˆ›å»ºå’Œç¼–è¯‘æ–‡ä»¶çš„èƒ½åŠ›ã€‚

1. **æŒ‡ä»¤åè®® (Modification)**: å¦‚æœä½ éœ€è¦ä¿®æ”¹ç°æœ‰æ–‡ä»¶æˆ–åˆ›å»ºæ–°æ–‡ä»¶ï¼Œ**å¿…é¡»**åœ¨ä»£ç å—ä¹‹å‰çš„ä¸€è¡Œï¼Œè¾“å‡ºæ ¼å¼ä¸º \`> FILE: path/to/file\` çš„æ ‡è®°ã€‚
   - ä¾‹å¦‚: \`> FILE: path/to/file\`
   - ä¾‹å¦‚: \`> FILE: src/extension.ts\`
   - å¿…é¡»è¾“å‡ºä¿®æ”¹åçš„**å®Œæ•´æ–‡ä»¶å†…å®¹**ã€‚

2. **ç¼–è¯‘æ”¯æŒ (Compilation)**:
   - ä½ å¯ä»¥æŒ‡å¯¼ç”¨æˆ·ç¼–è¯‘ä»£ç ã€‚
   - å¦‚æœç”¨æˆ·è¯¢é—®å¦‚ä½•è¿è¡Œï¼Œå‘Šè¯‰ä»–ä»¬å¯ä»¥ä½¿ç”¨å³ä¸Šè§’çš„ "â–¶ï¸" æŒ‰é’®æˆ–å¿«æ·é”® \`Ctrl+Shift+B\`ã€‚
   - å¯¹äº C/C++ï¼Œå»ºè®®ç”¨æˆ·æ£€æŸ¥ build ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
   - å¯¹äº Javaï¼Œç¼–è¯‘åä¼šç”Ÿæˆ .class æ–‡ä»¶åœ¨ build ç›®å½•ä¸‹ã€‚
   - å¯¹äº Pythonï¼Œè¿è¡Œçš„æ˜¯æºæ–‡ä»¶ï¼Œä¸éœ€è¦ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚
   - å¦‚æœé¡¹ç›®å¤æ‚ï¼Œå»ºè®®ç”Ÿæˆ Makefile æˆ– shell è„šæœ¬ã€‚

3. **æµç¨‹**: ç”¨æˆ·ç•Œé¢ä¼šè§£æä½ çš„è¾“å‡ºï¼Œæä¾›"âš¡ï¸ å®¡æŸ¥å¹¶åº”ç”¨"æŒ‰é’®ã€‚`;
    }

    // å¦‚æœæœ‰æœç´¢ç»“æœï¼Œå°†å…¶æ·»åŠ åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­
    let enhancedUserText = userText;
    if (webSearchResults) {
      enhancedUserText = userText + '\n\n' + webSearchResults;
    }

    const messages = [
      { role: 'system', content: systemPrompt },
      ...history,
      { role: 'user', content: enhancedUserText + contextPrompt }
    ];

    const temp = mode === 'agent' ? 0.1 : 0.7;

    console.log(`[LLMA] è°ƒç”¨æ¨¡å‹: ${model}, æ¶ˆæ¯æ•°: ${messages.length}`);
    const responseText = await callChatAI(model, apiKey, messages, config, 2000, temp);
    console.log(`[LLMA] å“åº”é•¿åº¦: ${responseText.length}`);
    this._view.webview.postMessage({ type: 'addResponse', text: responseText });

  } catch (error: any) {
    console.error('[LLMA] é”™è¯¯è¯¦æƒ…:', error);
    const errorMsg = `âŒ é”™è¯¯: ${error.message}`;
    
    if (model === 'local') {
      const baseUrl = config.get<string>('localModel.baseUrl') || 'http://localhost:11434/v1';
      const modelName = config.get<string>('localModel.modelName') || 'llama3';
      console.log(`[LLMA] æœ¬åœ°æ¨¡å‹è°ƒè¯•ä¿¡æ¯:`);
      console.log(`- Base URL: ${baseUrl}`);
      console.log(`- æ¨¡å‹åç§°: ${modelName}`);
      console.log(`- é”™è¯¯ä»£ç : ${error.code}`);
      console.log(`- é”™è¯¯è¯¦æƒ…:`, error);
      
      this._view.webview.postMessage({ 
        type: 'addResponse', 
        text: `${errorMsg}\n\nè°ƒè¯•ä¿¡æ¯:\n- æ¨¡å‹: ${modelName}\n- æœåŠ¡åœ°å€: ${baseUrl}\n- é”™è¯¯ç±»å‹: ${error.code || 'Unknown'}\n\nå¸¸è§è§£å†³æ–¹æ¡ˆ:\n1. ç¡®ä¿æœ¬åœ°æœåŠ¡(å¦‚ Ollama)å·²å¯åŠ¨\n2. æ£€æŸ¥æœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®\n3. åœ¨ç»ˆç«¯è¿è¡Œ: curl ${baseUrl}/tags æŸ¥çœ‹å¯ç”¨æ¨¡å‹` 
      });
    } else {
      this._view.webview.postMessage({ type: 'addResponse', text: errorMsg });
    }
  }
}

  private _getHtmlForWebview(webview: vscode.Webview) {
    const config = vscode.workspace.getConfiguration('llma');
    const defaultModel = config.get<string>('currentModel') || 'deepseek';
    const cspSource = webview.cspSource;
    
    // æ„å»º CSP
    const csp = `default-src 'none'; style-src ${cspSource} 'unsafe-inline'; script-src ${cspSource} 'unsafe-inline'; font-src ${cspSource} data:; img-src ${cspSource} data: https:;`;

    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="${csp}">
  <title>LLMA Pro - AI ç¼–ç¨‹åŠ©æ‰‹</title>
  <style>
    /* ... æ ·å¼ä¿æŒä¸å˜ï¼Œå·²çœç•¥ä»¥èŠ‚çœç©ºé—´ï¼Œä½†éœ€æ³¨æ„ä¿æŒåŸæœ‰æ ·å¼ ... */
    :root {
      --primary-color: #007acc;
      --primary-hover: #005fa3;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --bg-light: var(--vscode-sideBar-background);
      --bg-lighter: var(--vscode-sideBarSectionHeader-background);
      --border-color: var(--vscode-widget-border);
      --text-primary: var(--vscode-foreground);
      --text-secondary: var(--vscode-descriptionForeground);
      --text-tertiary: var(--vscode-disabledForeground);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
    }
    
    /* ===== é¡¶éƒ¨å·¥å…·æ  ===== */
    .header-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-lighter);
      border-bottom: 1px solid var(--border-color);
      min-height: 44px;
    }
    
    .model-selector {
      flex: 1;
      position: relative;
    }
    
    .model-select {
      width: 100%;
      padding: 5px 8px;
      background: var(--vscode-dropdown-background);
      color: var(--vscode-dropdown-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 12px;
      outline: none;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .model-select:hover {
      border-color: var(--primary-color);
    }
    
    .model-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    .btn-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      font-size: 13px;
    }
    
    .btn-icon:hover {
      background: var(--vscode-toolbar-hoverBackground);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    .btn-icon.active {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-icon.compile {
      background: linear-gradient(135deg, var(--success-color), #27ae60);
      color: white;
      border: none;
    }
    
    .btn-icon.compile:hover {
      background: linear-gradient(135deg, #27ae60, #219653);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ===== æ¨¡å¼åˆ‡æ¢å™¨ ===== */
    .mode-toggle {
      display: flex;
      background: var(--vscode-input-background);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 2px;
      gap: 2px;
    }
    
    .mode-btn {
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      background: transparent;
      border: none;
      border-radius: 3px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      white-space: nowrap;
    }
    
    .mode-btn:hover {
      color: var(--text-primary);
    }
    
    .mode-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* ===== ä¸Šä¸‹æ–‡æ  ===== */
    .context-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 12px;
      background: var(--vscode-list-hoverBackground);
      border-bottom: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .context-info {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow: hidden;
    }
    
    .context-icon {
      font-size: 11px;
      opacity: 0.7;
    }
    
    .context-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .context-actions {
      display: flex;
      gap: 4px;
    }
    
    /* ===== èŠå¤©å®¹å™¨ ===== */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--vscode-editor-background);
    }
    
    /* æ¬¢è¿æ¶ˆæ¯ */
    .welcome-message {
      background: linear-gradient(135deg, var(--primary-color), #3498db);
      color: white;
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 6px;
      box-shadow: var(--shadow-sm);
    }
    
    .welcome-message h3 {
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .welcome-message ul {
      list-style: none;
      padding-left: 0;
    }
    
    .welcome-message li {
      margin-bottom: 5px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .feature-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 500;
    }
    
    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      position: relative;
      animation: fadeIn 0.3s ease;
      line-height: 1.4;
      font-size: 13px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border-bottom-right-radius: var(--radius-sm);
    }
    
    .ai-message {
      align-self: flex-start;
      background: var(--vscode-editor-inactiveSelectionBackground);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: var(--radius-sm);
    }
    
    .message-time {
      font-size: 9px;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }
    
    /* ä»£ç å— */
    .code-block {
      position: relative;
      margin: 6px 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 8px;
      background: var(--vscode-textBlockQuote-background);
      border-bottom: 1px solid var(--border-color);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .language-tag {
      background: var(--primary-color);
      color: white;
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 500;
    }
    
    pre {
      margin: 0;
      padding: 10px;
      background: var(--vscode-textBlockQuote-background);
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    
    code {
      font-family: inherit;
    }
    
    /* æ–‡ä»¶æ“ä½œåŒºåŸŸ */
    .file-action-card {
      background: var(--vscode-editor-lineHighlightBackground);
      border-left: 3px solid var(--info-color);
      border-radius: var(--radius-md);
      padding: 10px;
      margin: 10px 0;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(-10px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .file-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .file-icon {
      font-size: 14px;
      color: var(--info-color);
    }
    
    .file-path {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .action-buttons {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    
    /* ===== æ–‡ä»¶é™„ä»¶åŒºåŸŸ ===== */
    .attachments-bar {
      padding: 6px 12px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-lighter);
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      min-height: 36px;
    }
    
    .attachments-label {
      font-size: 10px;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    .file-chips {
      display: flex;
      gap: 5px;
      flex: 1;
      overflow-x: auto;
      padding: 2px;
    }
    
    .file-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .file-chip:hover {
      background: var(--vscode-badge-hoverBackground);
    }
    
    .remove-chip {
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition-fast);
      font-size: 12px;
      line-height: 1;
    }
    
    .remove-chip:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    /* ===== è¾“å…¥åŒºåŸŸ ===== */
    .input-area {
      padding: 12px 12px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-lighter);
      position: relative;
    }
    
    .textarea-wrapper {
      position: relative;
      margin-bottom: 0;
    }
    
    textarea {
      width: 100%;
      min-height: 80px;
      max-height: 120px;
      padding: 10px 12px 40px 12px; /* åº•éƒ¨ç•™å‡ºæŒ‰é’®ç©ºé—´ */
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 13px;
      line-height: 1.4;
      resize: none;
      outline: none;
      transition: var(--transition-fast);
    }
    
    textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    textarea::placeholder {
      color: var(--text-tertiary);
    }
    
    /* æ–°çš„è¾“å…¥æ“ä½œåŒºåŸŸ - æ”¾åœ¨æ–‡æœ¬æ¡†å³ä¸‹è§’ */
    .input-actions {
      position: absolute;
      right: 10px;
      bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
    }
    
    .btn-attach {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--vscode-button-secondaryBackground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-fast);
      padding: 0;
    }
    
    .btn-attach:hover {
      background: var(--vscode-button-secondaryHoverBackground);
      color: var(--text-primary);
    }
    
    .hint-text {
      display: none; /* éšè—æç¤ºæ–‡å­—ï¼ŒèŠ‚çœç©ºé—´ */
    }
    
    .btn-send {
      padding: 6px 16px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      min-width: 60px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-send:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-send:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-stop {
      padding: 6px 16px;
      background: linear-gradient(135deg, var(--danger-color), #c0392b);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      min-width: 60px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-stop:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ç§»é™¤æ—§çš„å·¦å³æ“ä½œåŒºåŸŸæ ·å¼ */
    .left-actions, .right-actions {
      display: none;
    }
    
    /* ===== åŠ è½½åŠ¨ç”» ===== */
    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--vscode-editor-inactiveSelectionBackground);
      border-radius: var(--radius-md);
      margin: 6px 0;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    .loading-dots {
      display: flex;
      gap: 3px;
    }
    
    .loading-dot {
      width: 5px;
      height: 5px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* ===== æ¨¡æ€æ¡† ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: var(--vscode-editor-background);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 16px;
      color: var(--text-secondary);
      cursor: pointer;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
    }
    
    .modal-close:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }
    
    .modal-body {
      padding: 18px;
    }
    
    .settings-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 18px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-tab {
      padding: 6px 14px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .settings-tab:hover {
      color: var(--text-primary);
    }
    
    .settings-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .form-hint {
      display: block;
      margin-top: 3px;
      font-size: 10px;
      color: var(--text-tertiary);
    }
    
    .form-input {
      width: 100%;
      padding: 7px 10px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 12px;
      outline: none;
      transition: var(--transition-fast);
    }
    
    .form-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }
    
    .modal-footer {
      padding: 14px 18px;
      border-top: 1px solid var(--border-color);
      text-align: right;
    }
    
    .btn-primary {
      padding: 6px 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ===== å“åº”å¼è°ƒæ•´ ===== */
    @media (max-width: 600px) {
      .header-toolbar {
        padding: 6px;
      }
      
      .mode-btn {
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .message {
        max-width: 95%;
        padding: 8px 12px;
      }
      
      .chat-container {
        padding: 8px;
        gap: 10px;
      }
      
      .input-actions {
        right: 8px;
        bottom: 8px;
      }
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--vscode-scrollbarSlider-background);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--vscode-scrollbarSlider-hoverBackground);
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="header-toolbar">
    <div class="model-selector">
      <select class="model-select" id="model-select" aria-label="é€‰æ‹© AI æ¨¡å‹">
        <option value="deepseek" ${defaultModel === 'deepseek' ? 'selected' : ''}> DeepSeek</option>
        <option value="qwen" ${defaultModel === 'qwen' ? 'selected' : ''}> é€šä¹‰åƒé—®</option>
        <option value="douban" ${defaultModel === 'douban' ? 'selected' : ''}> è±†åŒ…(Volcengine)</option>
        <option value="zhipu" ${defaultModel === 'zhipu' ? 'selected' : ''}> æ™ºæ™®AI</option>
        <option value="local" ${defaultModel === 'local' ? 'selected' : ''}> æœ¬åœ°æ¨¡å‹</option>
      </select>
    </div>
    
    <button class="btn-icon compile" id="compile-btn" title="ç¼–è¯‘å½“å‰æ–‡ä»¶ (Ctrl+Shift+B)">
      â–¶
    </button>
    
    <button class="btn-icon" id="settings-btn" title="è®¾ç½®">
      âš™ï¸
    </button>
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-chat">èŠå¤©æ¨¡å¼</button>
      <button class="mode-btn" id="mode-agent">Agent æ¨¡å¼</button>
    </div>
  </div>
  
  <!-- ä¸Šä¸‹æ–‡æ  -->
  <div class="context-bar">
    <div class="context-info">
      <span class="context-icon">ğŸ“„</span>
      <span class="context-text" id="context-text">ç­‰å¾…ç¼–è¾‘å™¨æ¿€æ´»...</span>
    </div>
    <div class="context-actions">
      <button class="btn-icon" id="refresh-context" title="åˆ·æ–°ä¸Šä¸‹æ–‡">
        ğŸ”„
      </button>
    </div>
  </div>
  
  <!-- èŠå¤©å®¹å™¨ -->
  <div class="chat-container" id="chat-container">
    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <div class="welcome-message">
      <h3>âœ¨ LLMA Pro åŠ©æ‰‹å·²å°±ç»ª</h3>
      <ul>
        <li>ğŸ”„ <strong>èŠå¤©æ¨¡å¼</strong>: è·å–ä»£ç å»ºè®®å’Œè§£ç­”</li>
        <li>ğŸ¤– <strong>Agent æ¨¡å¼</strong>: åˆ›å»ºã€ä¿®æ”¹æ–‡ä»¶å¹¶ç¼–è¯‘ä»£ç </li>
        <li>âš¡ï¸ <strong>å¿«æ·é”®</strong>: Ctrl+Shift+B å¿«é€Ÿç¼–è¯‘å½“å‰æ–‡ä»¶</li>
        <li>ğŸ’¡ <strong>æç¤º</strong>: æ‹–æ‹½æ–‡ä»¶æˆ–ç‚¹å‡» ğŸ“ æ·»åŠ ä¸Šä¸‹æ–‡</li>
      </ul>
      <div class="feature-badges">
        <span class="badge">ä»£ç ç”Ÿæˆ</span>
        <span class="badge">æ™ºèƒ½é¢„æµ‹</span>
        <span class="badge">æ–‡ä»¶ç¼–è¯‘</span>
        <span class="badge">å¤šæ¨¡å‹æ”¯æŒ</span>
      </div>
    </div>
  </div>
  
  <!-- æ–‡ä»¶é™„ä»¶åŒºåŸŸ -->
  <div class="attachments-bar" id="attachments-bar">
    <span class="attachments-label">ğŸ“ å·²æ·»åŠ :</span>
    <div class="file-chips" id="file-chips">
      <!-- æ–‡ä»¶æ ‡ç­¾ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
  </div>
  
  <!-- è¾“å…¥åŒºåŸŸ -->
  <div class="input-area">
    <div class="textarea-wrapper">
      <textarea 
        id="message-input" 
        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤... (Enter å‘é€, Shift+Enter æ¢è¡Œ)"
        aria-label="è¾“å…¥æ¶ˆæ¯"
      ></textarea>
      <!-- è¾“å…¥æ“ä½œæŒ‰é’®åŒºåŸŸ - æ”¾åœ¨å³ä¸‹è§’ -->
      <div class="input-actions">
        <button class="btn-attach" id="attach-btn" title="æ·»åŠ æ–‡ä»¶">
          ğŸ“
        </button>
        <button class="btn-stop" id="stop-btn" style="display: none;" title="åœæ­¢ç”Ÿæˆ">
          åœæ­¢
        </button>
        <button class="btn-send" id="send-btn" title="å‘é€æ¶ˆæ¯">
          å‘é€
        </button>
      </div>
    </div>
  </div>
  
  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">âš™ï¸ LLMA Pro è®¾ç½®</h3>
        <button class="modal-close" id="close-settings">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="online">åœ¨çº¿æ¨¡å‹</button>
          <button class="settings-tab" data-tab="local">æœ¬åœ°æ¨¡å‹</button>
          <button class="settings-tab" data-tab="websearch">è”ç½‘æœç´¢</button>
        </div>
        
        <!-- åœ¨çº¿æ¨¡å‹è®¾ç½® -->
        <div id="online-settings" class="tab-content">
          <div class="form-group">
            <label class="form-label" for="key-deepseek">DeepSeek API Key</label>
            <input type="password" id="key-deepseek" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ DeepSeek API Key">
            <span class="form-hint">å¯åœ¨ DeepSeek å®˜ç½‘ç”³è¯·</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="key-qwen">é€šä¹‰åƒé—® API Key</label>
            <input type="password" id="key-qwen" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ Qwen API Key">
            <span class="form-hint">å¯åœ¨é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°è·å–</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="key-douban">è±†åŒ… API Key</label>
            <input type="password" id="key-douban" class="form-input" placeholder="è¾“å…¥æ‚¨çš„è±†åŒ… API Key">
            <span class="form-hint">å¯åœ¨ç«å±±å¼•æ“è·å–</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="model-douban">è±†åŒ… Endpoint ID (å¿…å¡«)</label>
            <input type="text" id="model-douban" class="form-input" placeholder="è¾“å…¥æ¥å…¥ç‚¹ID (å¦‚ ep-20240604094030-fwkl7)">
            <span class="form-hint">æ³¨æ„: è±†åŒ…å¿…é¡»å¡«å†™ Endpoint IDï¼Œä¸èƒ½ä½¿ç”¨ 'doubao-pro-32k' ç­‰æ¨¡å‹å</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="key-zhipu">æ™ºæ™®AI API Key</label>
            <input type="password" id="key-zhipu" class="form-input" placeholder="è¾“å…¥æ‚¨çš„æ™ºæ™®AI API Key">
            <span class="form-hint">å¯åœ¨æ™ºè°±AIå¼€æ”¾å¹³å°è·å–</span>
          </div>
        </div>
        
        <!-- æœ¬åœ°æ¨¡å‹è®¾ç½® -->
        <div id="local-settings" class="tab-content" style="display: none;">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="local-enabled">
              <label class="form-label" for="local-enabled">å¯ç”¨æœ¬åœ°æ¨¡å‹</label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-base-url">æœåŠ¡åœ°å€</label>
            <input type="text" id="local-base-url" class="form-input" placeholder="http://localhost:11434/v1">
            <span class="form-hint">ä¾‹å¦‚: Ollama é»˜è®¤åœ°å€ä¸º http://localhost:11434/v1</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-model-name">æ¨¡å‹åç§°</label>
            <input type="text" id="local-model-name" class="form-input" placeholder="llama3">
            <span class="form-hint">ä¾‹å¦‚: llama3, qwen2, codellama</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-timeout">è¯·æ±‚è¶…æ—¶ (æ¯«ç§’)</label>
            <input type="number" id="local-timeout" class="form-input" value="120000">
            <span class="form-hint">å»ºè®®å€¼: 120000 (2åˆ†é’Ÿ)</span>
          </div>
        </div>
        
        <!-- è”ç½‘æœç´¢è®¾ç½® -->
        <div id="websearch-settings" class="tab-content" style="display: none;">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="websearch-enabled">
              <label class="form-label" for="websearch-enabled">å¯ç”¨è”ç½‘æœç´¢</label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="bing-api-key">Bing æœç´¢ API Key</label>
            <input type="password" id="bing-api-key" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ Bing API Key">
            <span class="form-hint">å¯åœ¨ <a href="https://www.microsoft.com/cognitive-services/en-us/bing-web-search-api" target="_blank" style="color: var(--info-color);">Microsoft Azure</a> å…è´¹ç”³è¯·</span>
          </div>
          
          <div class="form-group">
            <label class="form-label">è¯´æ˜</label>
            <p style="font-size: 10px; color: var(--text-tertiary); line-height: 1.4;">
              å¯ç”¨è”ç½‘æœç´¢åï¼Œå½“æ‚¨çš„æé—®åŒ…å«"æœ€æ–°"ã€"å½“å‰"ã€"æœç´¢"ã€"å¤©æ°”"ç­‰å…³é”®è¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œç½‘ç»œæœç´¢ï¼Œå¹¶å°†æœç´¢ç»“æœæä¾›ç»™ AI åŠ©æ‰‹ï¼Œå¸®åŠ©å®ƒæä¾›æ›´å‡†ç¡®çš„å›ç­”ã€‚
            </p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-primary" id="save-settings-btn">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    
    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chat-container');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const stopBtn = document.getElementById('stop-btn');
    const attachBtn = document.getElementById('attach-btn');
    const modelSelect = document.getElementById('model-select');
    const compileBtn = document.getElementById('compile-btn');
    const refreshBtn = document.getElementById('refresh-context');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const modeChatBtn = document.getElementById('mode-chat');
    const modeAgentBtn = document.getElementById('mode-agent');
    const fileChips = document.getElementById('file-chips');
    const attachmentsBar = document.getElementById('attachments-bar');
    
    // çŠ¶æ€å˜é‡
    let history = [];
    let currentMode = 'chat';
    let attachedFiles = [];
    let isGenerating = false;
    let currentAbortController = null;
    let activeSettingsTab = 'online';
    
    // ===== åˆå§‹åŒ–å‡½æ•° =====
    function init() {
      // è®¾ç½®é»˜è®¤æ¨¡å¼
      setMode('chat');
      
      // åŠ è½½ä¿å­˜çš„çŠ¶æ€
      const savedState = vscode.getState();
      if (savedState) {
        if (savedState.attachedFiles) {
          attachedFiles = savedState.attachedFiles;
          renderFileChips();
        }
        if (savedState.currentMode) {
          setMode(savedState.currentMode);
        }
      }
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      bindEvents();
      
      // è¯·æ±‚åˆå§‹ä¸Šä¸‹æ–‡
      vscode.postMessage({ type: 'refreshContext' });
      
      // éšè—é™„ä»¶æ ï¼ˆå¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼‰
      updateAttachmentsBar();
    }
    
    // ===== äº‹ä»¶ç»‘å®š =====
    function bindEvents() {
      // æ¨¡å¼åˆ‡æ¢
      modeChatBtn.addEventListener('click', () => setMode('chat'));
      modeAgentBtn.addEventListener('click', () => setMode('agent'));
      
      // å‘é€æ¶ˆæ¯
      sendBtn.addEventListener('click', sendMessage);
      stopBtn.addEventListener('click', stopGeneration);
      
      // è¾“å…¥å¤„ç†
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // æ–‡ä»¶é™„ä»¶
      attachBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'selectContextFiles' });
      });
      
      // ç¼–è¯‘æŒ‰é’®
      compileBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'compileCurrentFile' });
      });
      
      // åˆ·æ–°ä¸Šä¸‹æ–‡
      refreshBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'refreshContext' });
      });
      
      // è®¾ç½®æ¨¡æ€æ¡†
      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      saveSettingsBtn.addEventListener('click', saveSettings);
      
      // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          switchSettingsTab(tabId);
        });
      });
      
      // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°è®¾ç½®æ ‡ç­¾é¡µ
      modelSelect.addEventListener('change', (e) => {
        if (e.target.value === 'local') {
          switchSettingsTab('local');
        } else {
          switchSettingsTab('online');
        }
      });
      
      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
      
      // æ”¯æŒæ–‡ä»¶æ‹–æ‹½
      attachmentsBar.addEventListener('dragover', (e) => {
        e.preventDefault();
        attachmentsBar.style.backgroundColor = 'var(--vscode-list-hoverBackground)';
      });
      
      attachmentsBar.addEventListener('dragleave', () => {
        attachmentsBar.style.backgroundColor = '';
      });
      
      attachmentsBar.addEventListener('drop', (e) => {
        e.preventDefault();
        attachmentsBar.style.backgroundColor = '';
        
        const files = Array.from(e.dataTransfer.files);
        const fileInfos = files.map(file => ({
          name: file.name,
          path: file.path
        }));
        
        vscode.postMessage({
          type: 'filesSelected',
          files: fileInfos
        });
      });
      
      // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
      input.addEventListener('input', autoResizeTextarea);
    }
    
    // ===== è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦ =====
    function autoResizeTextarea() {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }
    
    // ===== æ¨¡å¼åˆ‡æ¢ =====
    function setMode(mode) {
      currentMode = mode;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      modeChatBtn.classList.remove('active');
      modeAgentBtn.classList.remove('active');
      
      const activeBtn = mode === 'chat' ? modeChatBtn : modeAgentBtn;
      activeBtn.classList.add('active');
      
      // æ›´æ–°è¾“å…¥æ¡†æç¤º
      input.placeholder = mode === 'agent' 
        ? "è¾“å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š'åˆ›å»º src/utils.ts' æˆ– 'å¦‚ä½•ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶'..." 
        : "è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–ä»£ç è¯·æ±‚... (Enter å‘é€, Shift+Enter æ¢è¡Œ)";
      
      // ä¿å­˜çŠ¶æ€
      saveState();
    }
    
    // ===== æ¶ˆæ¯å¤„ç† =====
    function sendMessage() {
      const text = input.value.trim();
      if (!text || isGenerating) return;
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessage(text, 'user');
      input.value = '';
      autoResizeTextarea(); // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
      
      // å¼€å§‹ç”ŸæˆçŠ¶æ€
      isGenerating = true;
      updateButtonState();
      
      // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
      showLoadingIndicator();
      
      // å‘é€æ¶ˆæ¯åˆ°æ‰©å±•
      vscode.postMessage({
        type: 'sendMessage',
        text: text,
        history: history,
        model: modelSelect.value,
        mode: currentMode,
        files: attachedFiles.map(f => f.path)
      });
      
      // æ·»åŠ åˆ°å†å²
      history.push({ role: 'user', content: text });
      
      // ä¿å­˜çŠ¶æ€
      saveState();
    }
    
    function stopGeneration() {
      if (!isGenerating) return;
      
      hideLoadingIndicator();
      
      addMessage('âš ï¸ ç”Ÿæˆå·²åœæ­¢', 'ai', true);
      isGenerating = false;
      updateButtonState();
    }
    
    // ===== ç•Œé¢æ›´æ–°å‡½æ•° =====
    function addMessage(text, type, isError = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = \`message \${type}-message\`;
      
      if (isError) {
        messageDiv.style.background = 'linear-gradient(135deg, var(--danger-color), #c0392b)';
        messageDiv.style.color = 'white';
      }
      
      // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
      const formattedContent = formatMessageContent(text, type);
      messageDiv.innerHTML = formattedContent;
      
      // æ·»åŠ æ—¶é—´æˆ³
      const timeSpan = document.createElement('div');
      timeSpan.className = 'message-time';
      timeSpan.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageDiv.appendChild(timeSpan);
      
      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }
    
    function formatMessageContent(text, type) {
      if (type === 'user') {
        return escapeHtml(text);
      }
      
      // AI æ¶ˆæ¯å¤„ç†
      let html = '';
      let lines = text.split('\\n');
      let inCodeBlock = false;
      let currentLanguage = '';
      let buffer = '';
      
      // æ£€æµ‹æ–‡ä»¶æ“ä½œæ ‡è®°
      const fileActionMatch = text.match(/^> FILE:\\s*(.+?)$/m);
      
      lines.forEach(line => {
        // æ£€æµ‹ä»£ç å—å¼€å§‹
        if (line.startsWith('\`\`\`')) {
          if (!inCodeBlock) {
            // å¼€å§‹ä»£ç å—
            inCodeBlock = true;
            currentLanguage = line.substring(3).trim();
            html += buffer;
            buffer = '';
          } else {
            // ç»“æŸä»£ç å—
            html += \`<div class="code-block">
              <div class="code-header">
                <span>\${currentLanguage || 'code'}</span>
                <span class="language-tag">\${currentLanguage || 'text'}</span>
              </div>
              <pre><code>\${escapeHtml(buffer)}</code></pre>
            </div>\`;
            buffer = '';
            inCodeBlock = false;
            currentLanguage = '';
          }
          return;
        }
        
        if (inCodeBlock) {
          buffer += line + '\\n';
        } else {
          // å¤„ç†æ™®é€šæ–‡æœ¬
          if (line.trim().startsWith('> FILE:')) {
            const filePath = line.substring(7).trim();
            html += \`<div class="file-action-card">
              <div class="file-header">
                <span class="file-icon">ğŸ“„</span>
                <span class="file-path">\${escapeHtml(filePath)}</span>
              </div>
              <div class="action-buttons">
                <button class="btn-primary" onclick="applyFileChange('\${escapeHtml(filePath)}')">
                  âš¡ï¸ å®¡æŸ¥å¹¶åº”ç”¨
                </button>
              </div>
            </div>\`;
          } else if (line.trim()) {
            html += \`<p>\${escapeHtml(line)}</p>\`;
          }
        }
      });
      
      // å¤„ç†å‰©ä½™çš„ç¼“å†²åŒºå†…å®¹
      if (buffer.trim()) {
        html += buffer;
      }
      
      return html;
    }
    
    function showLoadingIndicator() {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.id = 'loading-indicator';
      loadingDiv.innerHTML = \`
        <div class="loading-dots">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
        <span>AI æ­£åœ¨æ€è€ƒ...</span>
      \`;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom();
    }
    
    function hideLoadingIndicator() {
      const loading = document.getElementById('loading-indicator');
      if (loading) loading.remove();
    }
    
    function updateButtonState() {
      if (isGenerating) {
        sendBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        input.disabled = true;
      } else {
        sendBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        input.disabled = false;
        input.focus();
      }
    }
    
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // ===== æ–‡ä»¶é™„ä»¶ç®¡ç† =====
    function renderFileChips() {
      fileChips.innerHTML = '';
      
      attachedFiles.forEach((file, index) => {
        const chip = document.createElement('div');
        chip.className = 'file-chip';
        chip.title = file.path;
        
        chip.innerHTML = \`
          <span>ğŸ“„ \${escapeHtml(file.name)}</span>
          <span class="remove-chip" data-index="\${index}">Ã—</span>
        \`;
        
        fileChips.appendChild(chip);
      });
      
      // æ·»åŠ åˆ é™¤äº‹ä»¶
      document.querySelectorAll('.remove-chip').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = parseInt(btn.dataset.index);
          attachedFiles.splice(index, 1);
          renderFileChips();
          updateAttachmentsBar();
          saveState();
        });
      });
    }
    
    function updateAttachmentsBar() {
      if (attachedFiles.length > 0) {
        attachmentsBar.style.display = 'flex';
      } else {
        attachmentsBar.style.display = 'none';
      }
    }
    
    // ===== è®¾ç½®ç®¡ç† =====
    function openSettings() {
      // æ ¹æ®å½“å‰é€‰æ‹©çš„æ¨¡å‹è®¾ç½®æ ‡ç­¾é¡µ
      if (modelSelect.value === 'local') {
        switchSettingsTab('local');
      } else {
        switchSettingsTab('online');
      }
      
      // è¯·æ±‚å½“å‰è®¾ç½®
      vscode.postMessage({ type: 'getSettings' });
      settingsModal.style.display = 'flex';
    }
    
    function closeSettings() {
      settingsModal.style.display = 'none';
    }
    
    function switchSettingsTab(tabId) {
      // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });
      
      // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
      document.getElementById('online-settings').style.display = 
        tabId === 'online' ? 'block' : 'none';
      document.getElementById('local-settings').style.display = 
        tabId === 'local' ? 'block' : 'none';
      document.getElementById('websearch-settings').style.display = 
        tabId === 'websearch' ? 'block' : 'none';
      
      activeSettingsTab = tabId;
    }
    
    function saveSettings() {
      const settings = {};
      
      if (activeSettingsTab === 'online') {
        settings.deepseekApiKey = document.getElementById('key-deepseek').value;
        settings.qwenApiKey = document.getElementById('key-qwen').value;
        settings.doubanApiKey = document.getElementById('key-douban').value;
        settings.doubanModel = document.getElementById('model-douban').value;
        settings.zhipuApiKey = document.getElementById('key-zhipu').value;
      } else if (activeSettingsTab === 'local') {
        settings.localModelEnabled = document.getElementById('local-enabled').checked;
        settings.localModelBaseUrl = document.getElementById('local-base-url').value;
        settings.localModelName = document.getElementById('local-model-name').value;
        settings.localModelTimeout = parseInt(document.getElementById('local-timeout').value) || 120000;
      } else if (activeSettingsTab === 'websearch') {
        settings.enableWebSearch = document.getElementById('websearch-enabled').checked;
        settings.bingApiKey = document.getElementById('bing-api-key').value;
      }
      
      vscode.postMessage({
        type: 'saveSettings',
        settings: settings
      });
      
      closeSettings();
    }
    
    // ===== è¾…åŠ©å‡½æ•° =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function saveState() {
      vscode.setState({
        attachedFiles: attachedFiles,
        currentMode: currentMode
      });
    }
    
    // å…¨å±€å‡½æ•°ä¾›æŒ‰é’®ä½¿ç”¨
    window.applyFileChange = function(filePath) {
      // è¿™é‡Œéœ€è¦ä»ä»£ç å—ä¸­æå–å†…å®¹
      // ç®€åŒ–å®ç°ï¼šæç¤ºç”¨æˆ·
      vscode.postMessage({
        type: 'applyFileChange',
        filepath: filePath,
        content: '[éœ€è¦ä»ä»£ç å—ä¸­æå–å†…å®¹]'
      });
    };
    
    // ===== æ¶ˆæ¯ç›‘å¬å™¨ =====
    window.addEventListener('message', event => {
      const message = event.data;
      
      switch (message.type) {
        case 'addResponse':
          hideLoadingIndicator();
          addMessage(message.text, 'ai');
          history.push({ role: 'assistant', content: message.text });
          isGenerating = false;
          updateButtonState();
          break;
          
        case 'updateContextInfo':
          document.getElementById('context-text').textContent = message.text;
          break;
          
        case 'filesSelected':
          message.files.forEach(file => {
            if (!attachedFiles.some(f => f.path === file.path)) {
              attachedFiles.push(file);
            }
          });
          renderFileChips();
          updateAttachmentsBar();
          saveState();
          break;
          
        case 'updateSettings':
          // æ›´æ–°è¡¨å•å­—æ®µ
          if (message.settings.deepseekApiKey) {
            document.getElementById('key-deepseek').value = message.settings.deepseekApiKey;
          }
          if (message.settings.qwenApiKey) {
            document.getElementById('key-qwen').value = message.settings.qwenApiKey;
          }
          if (message.settings.doubanApiKey) {
            document.getElementById('key-douban').value = message.settings.doubanApiKey;
          }
          if (message.settings.doubanModel) {
            document.getElementById('model-douban').value = message.settings.doubanModel;
          }
          if (message.settings.zhipuApiKey) {
            document.getElementById('key-zhipu').value = message.settings.zhipuApiKey;
          }
          if (message.settings.localModelEnabled !== undefined) {
            document.getElementById('local-enabled').checked = message.settings.localModelEnabled;
          }
          if (message.settings.localModelBaseUrl) {
            document.getElementById('local-base-url').value = message.settings.localModelBaseUrl;
          }
          if (message.settings.localModelName) {
            document.getElementById('local-model-name').value = message.settings.localModelName;
          }
          if (message.settings.localModelTimeout) {
            document.getElementById('local-timeout').value = message.settings.localModelTimeout;
          }
          if (message.settings.enableWebSearch !== undefined) {
            document.getElementById('websearch-enabled').checked = message.settings.enableWebSearch;
          }
          if (message.settings.bingApiKey) {
            document.getElementById('bing-api-key').value = message.settings.bingApiKey;
          }
          break;
      }
    });
    
    // åˆå§‹åŒ–åº”ç”¨
    init();
  </script>
</body>
</html>`;
  }
}

/**
 * æ™ºèƒ½ä»£ç ç”Ÿæˆ (Ctrl+Shift+A)
 */
async function handleExplicitCodeGeneration() {
  const editor = vscode.window.activeTextEditor;
  if (!editor) {
    vscode.window.showWarningMessage('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨');
    return;
  }

  const document = editor.document;
  const selection = editor.selection;
  const cursorLine = selection.active.line;
  
  const startContextLine = Math.max(0, cursorLine - 100);
  const endContextLine = Math.min(document.lineCount - 1, cursorLine + 20);
  
  const textBefore = document.getText(new vscode.Range(startContextLine, 0, selection.start.line, selection.start.character));
  const textSelected = document.getText(selection);
  const textAfter = document.getText(new vscode.Range(selection.end.line, selection.end.character, endContextLine, document.lineAt(endContextLine).range.end.character));

  const currentIndent = document.lineAt(cursorLine).text.match(/^\s*/)?.[0] || '';

  try {
    await vscode.window.withProgress({
      location: vscode.ProgressLocation.Notification,
      title: "LLMA æ­£åœ¨ç”Ÿæˆä»£ç ...",
      cancellable: true
    }, async (progress, token) => {
      
      const config = vscode.workspace.getConfiguration('llma');
      const currentModel = config.get<string>('currentModel') || 'deepseek';
      const apiKey = getApiKey(config, currentModel);
      
      if (!apiKey) {
        vscode.window.showErrorMessage(`è¯·å…ˆé…ç½® ${currentModel} çš„ API å¯†é’¥`);
        return;
      }

      progress.report({ increment: 20 });
      
      const isInsertion = textSelected.trim().length === 0;
      let systemPrompt = `You are an expert coding assistant. Return ONLY the code block. No markdown fencing, no explanation. Maintain indentation: "${currentIndent}".`;
      let userPrompt = "";

      if (isInsertion) {
        userPrompt = `
[FILE: ${path.basename(document.fileName)}]
[LANGUAGE: ${document.languageId}]
[CODE BEFORE CURSOR]:
${textBefore}
<CURSOR>
[CODE AFTER CURSOR]:
${textAfter}

INSTRUCTION: Generate the code that belongs at <CURSOR>. Just the code.
`;
      } else {
        userPrompt = `
[FILE: ${path.basename(document.fileName)}]
[CONTEXT BEFORE]:
${textBefore.slice(-500)}

[SELECTED CODE TO PROCESS]:
${textSelected}

[INSTRUCTION]:
Optimize, fix, or implement the logic described in the selected code.
Return only the replaced code.
`;
      }

      progress.report({ increment: 40 });

      const completion = await callSimpleAI(
        currentModel, apiKey, systemPrompt, userPrompt, 2000, 0.2, config
      );

      if (token.isCancellationRequested) { return; }

      if (completion) {
        progress.report({ increment: 90 });
        await editor.edit(editBuilder => {
          let cleanCode = completion.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '');
          if (selection.isEmpty) {
             editBuilder.insert(selection.active, cleanCode);
          } else {
             editBuilder.replace(selection, cleanCode);
          }
        });
      }
    });
  } catch (error: any) {
    vscode.window.showErrorMessage(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
  }
}

/**
 * è¡Œå†…ä»£ç é¢„æµ‹æä¾›è€… (Ghost Text)
 */
class LLMAInlineCompletionProvider implements vscode.InlineCompletionItemProvider {
  private _abortController: AbortController | null = null;
  private _timer: NodeJS.Timeout | null = null;

  async provideInlineCompletionItems(
    document: vscode.TextDocument,
    position: vscode.Position,
    context: vscode.InlineCompletionContext,
    token: vscode.CancellationToken
  ): Promise<vscode.InlineCompletionItem[] | vscode.InlineCompletionList> {
    
    const config = vscode.workspace.getConfiguration('llma');
    if (!config.get<boolean>('enableAutoCompletion')) { return []; }

    if (this._timer) { clearTimeout(this._timer); }
    if (this._abortController) { this._abortController.abort(); }

    const delay = config.get<number>('requestDelay') || 300;

    return new Promise((resolve) => {
      this._timer = setTimeout(async () => {
        if (token.isCancellationRequested) { resolve([]); return; }

        try {
          updateStatusBar(true);
          this._abortController = new AbortController();
          const signal = this._abortController.signal;

          token.onCancellationRequested(() => {
            this._abortController?.abort();
            updateStatusBar(false);
            resolve([]);
          });

          const promptData = this.prepareSmartContext(document, position);
          if (!promptData) {
            updateStatusBar(false);
            resolve([]);
            return;
          }

          const completionText = await this.fetchAICompletion(promptData, config, signal);

          if (!completionText || completionText.trim().length === 0) {
            updateStatusBar(false);
            resolve([]);
            return;
          }

          const item = new vscode.InlineCompletionItem(
            completionText,
            new vscode.Range(position, position)
          );
          
          updateStatusBar(false);
          resolve([item]);

        } catch (error) {
          updateStatusBar(false);
          resolve([]);
        }
      }, delay);
    });
  }

  private prepareSmartContext(document: vscode.TextDocument, position: vscode.Position) {
    const windowSizeLines = 60;
    const startLine = Math.max(0, position.line - windowSizeLines);
    const endLine = Math.min(document.lineCount - 1, position.line + 10);
    
    const rangeBefore = new vscode.Range(startLine, 0, position.line, position.character);
    const rangeAfter = new vscode.Range(position.line, position.character, endLine, document.lineAt(endLine).range.end.character);
    
    const textBefore = document.getText(rangeBefore);
    const textAfter = document.getText(rangeAfter);

    if (textBefore.trim().length < 1) { return null; }

    return {
      prefix: textBefore,
      suffix: textAfter,
      language: document.languageId,
      filename: path.basename(document.fileName)
    };
  }

  private async fetchAICompletion(
    data: { prefix: string, suffix: string, language: string, filename: string },
    config: vscode.WorkspaceConfiguration,
    signal: AbortSignal
  ): Promise<string> {
    const model = config.get<string>('currentModel') || 'deepseek';
    const apiKey = getApiKey(config, model);
    if (!apiKey) { return ''; }

    const systemPrompt = `You are a code completion engine. Output ONLY the code to fill the <CURSOR> gap. DO NOT repeat prefix/suffix. No Markdown.`;
    const userPrompt = `
File: ${data.filename}
Lang: ${data.language}

[CODE START]
${data.prefix}<CURSOR>${data.suffix}
[CODE END]

Task: Fill in <CURSOR>.
`;
    const maxTokens = 100;
    return await callSimpleAI(model, apiKey, systemPrompt, userPrompt, maxTokens, 0.0, config, signal);
  }
}

// --- è”ç½‘æœç´¢åŠŸèƒ½ ---

interface SearchResult {
  title: string;
  url: string;
  snippet: string;
}

/**
 * ä½¿ç”¨ Bing æœç´¢ API è¿›è¡Œç½‘ç»œæœç´¢
 * @param query æœç´¢æŸ¥è¯¢
 * @param apiKey Bing API Key
 * @param maxResults æœ€å¤§ç»“æœæ•°é‡
 * @returns æœç´¢ç»“æœåˆ—è¡¨
 */
async function searchWeb(query: string, apiKey: string, maxResults: number = 5): Promise<SearchResult[]> {
  const url = 'https://api.bing.microsoft.com/v7.0/search';
  
  try {
    const response = await axios.get(url, {
      params: {
        q: query,
        count: maxResults,
        mkt: 'zh-CN'
      },
      headers: {
        'Ocp-Apim-Subscription-Key': apiKey
      },
      timeout: 10000
    });

    const results: SearchResult[] = [];
    if (response.data.webPages && response.data.webPages.value) {
      response.data.webPages.value.forEach((item: any) => {
        results.push({
          title: item.name,
          url: item.url,
          snippet: item.snippet
        });
      });
    }

    return results;
  } catch (error: any) {
    console.error('ç½‘ç»œæœç´¢å¤±è´¥:', error.message);
    throw new Error(`ç½‘ç»œæœç´¢å¤±è´¥: ${error.message}`);
  }
}

/**
 * æ£€æµ‹ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
 * @param userMessage ç”¨æˆ·æ¶ˆæ¯
 * @returns æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
 */
function needsWebSearch(userMessage: string): boolean {
  const searchKeywords = [
    'æœ€æ–°', 'æ–°é—»', 'å½“å‰', 'ç°åœ¨', 'å®æ—¶', 'æœç´¢', 'æŸ¥ä¸€ä¸‹', 'æŸ¥è¯¢',
    'å¤©æ°”', 'æ±‡ç‡', 'è‚¡ç¥¨', 'ä»·æ ¼', 'æœ€è¿‘', 'ä»Šå¤©', 'ä»Šå¹´', '2024', '2025',
    'what is', 'latest', 'current', 'search', 'find', 'look up'
  ];
  
  const lowerMessage = userMessage.toLowerCase();
  return searchKeywords.some(keyword => lowerMessage.includes(keyword.toLowerCase()));
}

/**
 * æ ¼å¼åŒ–æœç´¢ç»“æœä¸ºæ–‡æœ¬
 * @param results æœç´¢ç»“æœåˆ—è¡¨
 * @returns æ ¼å¼åŒ–åçš„æ–‡æœ¬
 */
function formatSearchResults(results: SearchResult[]): string {
  if (results.length === 0) {
    return 'æœªæ‰¾åˆ°ç›¸å…³ç»“æœã€‚';
  }

  let formatted = 'ğŸŒ ç½‘ç»œæœç´¢ç»“æœ:\n\n';
  results.forEach((result, index) => {
    formatted += `${index + 1}. **${result.title}**\n`;
    formatted += `   ${result.snippet}\n`;
    formatted += `   æ¥æº: ${result.url}\n\n`;
  });

  return formatted;
}

// --- é€šç”¨ API è°ƒç”¨å‡½æ•° ---

async function callSimpleAI(
  model: string,
  apiKey: string,
  systemPrompt: string,
  userPrompt: string,
  maxTokens: number,
  temperature: number,
  config: vscode.WorkspaceConfiguration,
  signal?: AbortSignal
): Promise<string> {
  const messages = [
    { role: 'system', content: systemPrompt }, 
    { role: 'user', content: userPrompt }
  ];
  return await callChatAI(model, apiKey, messages, config, maxTokens, temperature, signal);
}

async function callChatAI(
  model: string,
  apiKey: string | undefined,
  messages: any[],
  config: vscode.WorkspaceConfiguration,
  maxTokens: number = 2000,
  temperature: number = 0.7,
  signal?: AbortSignal
): Promise<string> {
  let url = '';
  let payload: any = {
    messages: messages,
    max_tokens: maxTokens,
    temperature: temperature,
    stream: false
  };
  
  const headers: any = {
    'Content-Type': 'application/json'
  };

  if (model === 'local') {
    const localEnabled = config.get<boolean>('localModel.enabled', false);
    if (!localEnabled) {
      throw new Error('æœ¬åœ°æ¨¡å‹æœªå¯ç”¨ï¼Œè¯·åœ¨è®¾ç½®ä¸­å¯ç”¨æœ¬åœ°æ¨¡å‹');
    }
    
    const baseUrl = config.get<string>('localModel.baseUrl') || 'http://localhost:11434/v1';
    const modelName = config.get<string>('localModel.modelName') || 'llama3';
    const timeout = config.get<number>('localModel.timeout') || 120000;
    
    url = `${baseUrl}/chat/completions`;
    payload.model = modelName;
    
    if (apiKey) {
      headers['Authorization'] = `Bearer ${apiKey}`;
    }
    
    try {
      const response = await axios.post(url, payload, { headers, signal, timeout });
      return response.data.choices[0]?.message?.content || '';
    } catch (error: any) {
      if (!axios.isCancel(error)) {
        console.error('æœ¬åœ°æ¨¡å‹è°ƒç”¨å¤±è´¥:', error.message);
        if (error.code === 'ECONNREFUSED') {
          throw new Error('æ— æ³•è¿æ¥åˆ°æœ¬åœ°æ¨¡å‹æœåŠ¡ï¼Œè¯·ç¡®ä¿ Ollama æˆ–å…¶ä»–æœ¬åœ°æœåŠ¡å·²å¯åŠ¨');
        }
        throw error;
      }
      return '';
    }
  } else if (model === 'deepseek') {
    url = 'https://api.deepseek.com/chat/completions';
    payload.model = 'deepseek-coder';
    headers['Authorization'] = `Bearer ${apiKey}`;
  } else if (model === 'qwen') {
    const baseUrl = config.get<string>('qwenBaseUrl') || 'https://dashscope.aliyuncs.com/compatible-mode/v1';
    url = `${baseUrl}/chat/completions`;
    payload.model = 'qwen-coder-turbo';
    headers['Authorization'] = `Bearer ${apiKey}`;
  } else if (model === 'douban') {
    url = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
    // ä¿®å¤: ä½¿ç”¨é…ç½®ä¸­çš„ Endpoint IDï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„æ¨¡å‹å
    const endpointId = config.get<string>('doubanModel');
    if (!endpointId) {
      throw new Error('æœªé…ç½®è±†åŒ… Endpoint IDï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ ');
    }
    payload.model = endpointId;
    headers['Authorization'] = `Bearer ${apiKey}`;
  } else if (model === 'zhipu') {
    url = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
    payload.model = 'glm-4';
    headers['Authorization'] = `Bearer ${apiKey}`;
  }

  try {
    const response = await axios.post(url, payload, { headers, signal, timeout: 60000 });
    return response.data.choices[0]?.message?.content || '';
  } catch (error: any) {
    if (!axios.isCancel(error)) {
      console.error('API Error:', error.message);
      // å¢åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
      if (error.response) {
         console.error('Data:', error.response.data);
         if (model === 'douban') {
            throw new Error(`è±†åŒ…APIé”™è¯¯: ${JSON.stringify(error.response.data)}`);
         }
      }
      throw error;
    }
    return '';
  }
}

// --- è¾…åŠ©å‡½æ•° ---

function updateStatusBar(isLoading: boolean) {
  const config = vscode.workspace.getConfiguration('llma');
  const enabled = config.get<boolean>('enableAutoCompletion');

  if (!enabled) {
    statusBarItem.text = `$(circle-slash) LLMA Off`;
  } else if (isLoading) {
    statusBarItem.text = `$(sync~spin) LLMA...`;
  } else {
    statusBarItem.text = `$(hubot) LLMA`;
  }
}

function getApiKey(config: vscode.WorkspaceConfiguration, model: string): string | undefined {
  if (model === 'local') {
    return 'local';
  }
  switch (model) {
    case 'deepseek': return config.get<string>('deepseekApiKey');
    case 'qwen': return config.get<string>('qwenApiKey');
    case 'douban': return config.get<string>('doubanApiKey');
    case 'zhipu': return config.get<string>('zhipuApiKey');
    default: return undefined;
  }
}