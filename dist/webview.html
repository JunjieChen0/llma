<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="">
  <title>LLMA Pro - AI ç¼–ç¨‹åŠ©æ‰‹</title>
  <style>
    :root {
      --primary-color: #007acc;
      --primary-hover: #005fa3;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --bg-light: var(--vscode-sideBar-background);
      --bg-lighter: var(--vscode-sideBarSectionHeader-background);
      --border-color: var(--vscode-widget-border);
      --text-primary: var(--vscode-foreground);
      --text-secondary: var(--vscode-descriptionForeground);
      --text-tertiary: var(--vscode-disabledForeground);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
    }
    
    /* ===== é¡¶éƒ¨å·¥å…·æ  ===== */
    .header-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-lighter);
      border-bottom: 1px solid var(--border-color);
      min-height: 44px;
    }
    
    .model-selector {
      flex: 1;
      position: relative;
    }
    
    .model-select {
      width: 100%;
      padding: 5px 8px;
      background: var(--vscode-dropdown-background);
      color: var(--vscode-dropdown-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 12px;
      outline: none;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .model-select:hover {
      border-color: var(--primary-color);
    }
    
    .model-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    .btn-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      font-size: 13px;
    }
    
    .btn-icon:hover {
      background: var(--vscode-toolbar-hoverBackground);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    .btn-icon.active {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-icon.compile {
      background: linear-gradient(135deg, var(--success-color), #27ae60);
      color: white;
      border: none;
    }
    
    .btn-icon.compile:hover {
      background: linear-gradient(135deg, #27ae60, #219653);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ===== æ¨¡å¼åˆ‡æ¢å™¨ ===== */
    .mode-toggle {
      display: flex;
      background: var(--vscode-input-background);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 2px;
      gap: 2px;
    }
    
    .mode-btn {
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      background: transparent;
      border: none;
      border-radius: 3px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      white-space: nowrap;
    }
    
    .mode-btn:hover {
      color: var(--text-primary);
    }
    
    .mode-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* ===== ä¸Šä¸‹æ–‡æ  ===== */
    .context-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 12px;
      background: var(--vscode-list-hoverBackground);
      border-bottom: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .context-info {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow: hidden;
    }
    
    .context-icon {
      font-size: 11px;
      opacity: 0.7;
    }
    
    .context-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .context-actions {
      display: flex;
      gap: 4px;
    }
    
    /* ===== èŠå¤©å®¹å™¨ ===== */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--vscode-editor-background);
    }
    
    /* æ¬¢è¿æ¶ˆæ¯ */
    .welcome-message {
      background: linear-gradient(135deg, var(--primary-color), #3498db);
      color: white;
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 6px;
      box-shadow: var(--shadow-sm);
    }
    
    .welcome-message h3 {
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .welcome-message ul {
      list-style: none;
      padding-left: 0;
    }
    
    .welcome-message li {
      margin-bottom: 5px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .feature-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 500;
    }
    
    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      position: relative;
      animation: fadeIn 0.3s ease;
      line-height: 1.4;
      font-size: 13px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border-bottom-right-radius: var(--radius-sm);
    }
    
    .ai-message {
      align-self: flex-start;
      background: var(--vscode-editor-inactiveSelectionBackground);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: var(--radius-sm);
    }
    
    .message-time {
      font-size: 9px;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }
    
    /* ä»£ç å— */
    .code-block {
      position: relative;
      margin: 6px 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 8px;
      background: var(--vscode-textBlockQuote-background);
      border-bottom: 1px solid var(--border-color);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .language-tag {
      background: var(--primary-color);
      color: white;
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 500;
    }
    
    pre {
      margin: 0;
      padding: 10px;
      background: var(--vscode-textBlockQuote-background);
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    
    code {
      font-family: inherit;
    }
    
    /* æ–‡ä»¶æ“ä½œåŒºåŸŸ */
    .file-action-card {
      background: var(--vscode-editor-lineHighlightBackground);
      border-left: 3px solid var(--info-color);
      border-radius: var(--radius-md);
      padding: 10px;
      margin: 10px 0;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(-10px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .file-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .file-icon {
      font-size: 14px;
      color: var(--info-color);
    }
    
    .file-path {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .action-buttons {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    
    /* ===== æ–‡ä»¶é™„ä»¶åŒºåŸŸ ===== */
    .attachments-bar {
      padding: 6px 12px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-lighter);
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      min-height: 36px;
    }
    
    .attachments-label {
      font-size: 10px;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    .file-chips {
      display: flex;
      gap: 5px;
      flex: 1;
      overflow-x: auto;
      padding: 2px;
    }
    
    .file-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .file-chip:hover {
      background: var(--vscode-badge-hoverBackground);
    }
    
    .remove-chip {
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition-fast);
      font-size: 12px;
      line-height: 1;
    }
    
    .remove-chip:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    /* ===== è¾“å…¥åŒºåŸŸ ===== */
    .input-area {
      padding: 12px 12px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-lighter);
      position: relative;
    }
    
    .textarea-wrapper {
      position: relative;
      margin-bottom: 0;
    }
    
    textarea {
      width: 100%;
      min-height: 80px;
      max-height: 120px;
      padding: 10px 12px 40px 12px; /* åº•éƒ¨ç•™å‡ºæŒ‰é’®ç©ºé—´ */
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 13px;
      line-height: 1.4;
      resize: none;
      outline: none;
      transition: var(--transition-fast);
    }
    
    textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    textarea::placeholder {
      color: var(--text-tertiary);
    }
    
    /* æ–°çš„è¾“å…¥æ“ä½œåŒºåŸŸ - æ”¾åœ¨æ–‡æœ¬æ¡†å³ä¸‹è§’ */
    .input-actions {
      position: absolute;
      right: 10px;
      bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
    }
    
    .btn-attach {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--vscode-button-secondaryBackground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-fast);
      padding: 0;
    }
    
    .btn-attach:hover {
      background: var(--vscode-button-secondaryHoverBackground);
      color: var(--text-primary);
    }
    
    .hint-text {
      display: none; /* éšè—æç¤ºæ–‡å­—ï¼ŒèŠ‚çœç©ºé—´ */
    }
    
    .btn-send {
      padding: 6px 16px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      min-width: 60px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-send:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-send:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-stop {
      padding: 6px 16px;
      background: linear-gradient(135deg, var(--danger-color), #c0392b);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      min-width: 60px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-stop:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ç§»é™¤æ—§çš„å·¦å³æ“ä½œåŒºåŸŸæ ·å¼ */
    .left-actions, .right-actions {
      display: none;
    }
    
    /* ===== åŠ è½½åŠ¨ç”» ===== */
    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--vscode-editor-inactiveSelectionBackground);
      border-radius: var(--radius-md);
      margin: 6px 0;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    .loading-dots {
      display: flex;
      gap: 3px;
    }
    
    .loading-dot {
      width: 5px;
      height: 5px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* ===== æ¨¡æ€æ¡† ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: var(--vscode-editor-background);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 16px;
      color: var(--text-secondary);
      cursor: pointer;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
    }
    
    .modal-close:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }
    
    .modal-body {
      padding: 18px;
    }
    
    .settings-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 18px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-tab {
      padding: 6px 14px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .settings-tab:hover {
      color: var(--text-primary);
    }
    
    .settings-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .form-hint {
      display: block;
      margin-top: 3px;
      font-size: 10px;
      color: var(--text-tertiary);
    }
    
    .form-input {
      width: 100%;
      padding: 7px 10px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 12px;
      outline: none;
      transition: var(--transition-fast);
    }
    
    .form-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }
    
    .modal-footer {
      padding: 14px 18px;
      border-top: 1px solid var(--border-color);
      text-align: right;
    }
    
    .btn-primary {
      padding: 6px 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ===== å“åº”å¼è°ƒæ•´ ===== */
    @media (max-width: 600px) {
      .header-toolbar {
        padding: 6px;
      }
      
      .mode-btn {
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .message {
        max-width: 95%;
        padding: 8px 12px;
      }
      
      .chat-container {
        padding: 8px;
        gap: 10px;
      }
      
      .input-actions {
        right: 8px;
        bottom: 8px;
      }
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--vscode-scrollbarSlider-background);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--vscode-scrollbarSlider-hoverBackground);
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="header-toolbar">
    <div class="model-selector">
      <select class="model-select" id="model-select" aria-label="é€‰æ‹© AI æ¨¡å‹">
        <option value="deepseek"> DeepSeek</option>
        <option value="qwen"> é€šä¹‰åƒé—®</option>
        <option value="douban"> è±†åŒ…</option>
        <option value="local"> æœ¬åœ°æ¨¡å‹</option>
      </select>
    </div>
    
    <button class="btn-icon compile" id="compile-btn" title="ç¼–è¯‘å½“å‰æ–‡ä»¶ (Ctrl+Shift+B)">
      â–¶
    </button>
    
    <button class="btn-icon" id="settings-btn" title="è®¾ç½®">
      âš™ï¸
    </button>
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-chat">èŠå¤©æ¨¡å¼</button>
      <button class="mode-btn" id="mode-agent">Agent æ¨¡å¼</button>
    </div>
  </div>
  
  <!-- ä¸Šä¸‹æ–‡æ  -->
  <div class="context-bar">
    <div class="context-info">
      <span class="context-icon">ğŸ“„</span>
      <span class="context-text" id="context-text">ç­‰å¾…ç¼–è¾‘å™¨æ¿€æ´»...</span>
    </div>
    <div class="context-actions">
      <button class="btn-icon" id="refresh-context" title="åˆ·æ–°ä¸Šä¸‹æ–‡">
        ğŸ”„
      </button>
    </div>
  </div>
  
  <!-- èŠå¤©å®¹å™¨ -->
  <div class="chat-container" id="chat-container">
    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <div class="welcome-message">
      <h3>âœ¨ LLMA Pro åŠ©æ‰‹å·²å°±ç»ª</h3>
      <ul>
        <li>ğŸ”„ <strong>èŠå¤©æ¨¡å¼</strong>: è·å–ä»£ç å»ºè®®å’Œè§£ç­”</li>
        <li>ğŸ¤– <strong>Agent æ¨¡å¼</strong>: åˆ›å»ºã€ä¿®æ”¹æ–‡ä»¶å¹¶ç¼–è¯‘ä»£ç </li>
        <li>âš¡ï¸ <strong>å¿«æ·é”®</strong>: Ctrl+Shift+B å¿«é€Ÿç¼–è¯‘å½“å‰æ–‡ä»¶</li>
        <li>ğŸ’¡ <strong>æç¤º</strong>: æ‹–æ‹½æ–‡ä»¶æˆ–ç‚¹å‡» ğŸ“ æ·»åŠ ä¸Šä¸‹æ–‡</li>
      </ul>
      <div class="feature-badges">
        <span class="badge">ä»£ç ç”Ÿæˆ</span>
        <span class="badge">æ™ºèƒ½é¢„æµ‹</span>
        <span class="badge">æ–‡ä»¶ç¼–è¯‘</span>
        <span class="badge">å¤šæ¨¡å‹æ”¯æŒ</span>
      </div>
    </div>
  </div>
  
  <!-- æ–‡ä»¶é™„ä»¶åŒºåŸŸ -->
  <div class="attachments-bar" id="attachments-bar">
    <span class="attachments-label">ğŸ“ å·²æ·»åŠ :</span>
    <div class="file-chips" id="file-chips">
      <!-- æ–‡ä»¶æ ‡ç­¾ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
  </div>
  
  <!-- è¾“å…¥åŒºåŸŸ -->
  <div class="input-area">
    <div class="textarea-wrapper">
      <textarea 
        id="message-input" 
        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤... (Enter å‘é€, Shift+Enter æ¢è¡Œ)"
        aria-label="è¾“å…¥æ¶ˆæ¯"
      ></textarea>
      <!-- è¾“å…¥æ“ä½œæŒ‰é’®åŒºåŸŸ - æ”¾åœ¨å³ä¸‹è§’ -->
      <div class="input-actions">
        <button class="btn-attach" id="attach-btn" title="æ·»åŠ æ–‡ä»¶">
          ğŸ“
        </button>
        <button class="btn-stop" id="stop-btn" style="display: none;" title="åœæ­¢ç”Ÿæˆ">
          åœæ­¢
        </button>
        <button class="btn-send" id="send-btn" title="å‘é€æ¶ˆæ¯">
          å‘é€
        </button>
      </div>
    </div>
  </div>
  
  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">âš™ï¸ LLMA Pro è®¾ç½®</h3>
        <button class="modal-close" id="close-settings">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="online">åœ¨çº¿æ¨¡å‹</button>
          <button class="settings-tab" data-tab="local">æœ¬åœ°æ¨¡å‹</button>
        </div>
        
        <!-- åœ¨çº¿æ¨¡å‹è®¾ç½® -->
        <div id="online-settings" class="tab-content">
          <div class="form-group">
            <label class="form-label" for="key-deepseek">DeepSeek API Key</label>
            <input type="password" id="key-deepseek" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ DeepSeek API Key">
            <span class="form-hint">å¯åœ¨ DeepSeek å®˜ç½‘ç”³è¯·</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="key-qwen">é€šä¹‰åƒé—® API Key</label>
            <input type="password" id="key-qwen" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ Qwen API Key">
            <span class="form-hint">å¯åœ¨é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°è·å–</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="key-douban">è±†åŒ… API Key</label>
            <input type="password" id="key-douban" class="form-input" placeholder="è¾“å…¥æ‚¨çš„è±†åŒ… API Key">
            <span class="form-hint">å¯åœ¨ç«å±±å¼•æ“è·å–</span>
          </div>
        </div>
        
        <!-- æœ¬åœ°æ¨¡å‹è®¾ç½® -->
        <div id="local-settings" class="tab-content" style="display: none;">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="local-enabled">
              <label class="form-label" for="local-enabled">å¯ç”¨æœ¬åœ°æ¨¡å‹</label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-base-url">æœåŠ¡åœ°å€</label>
            <input type="text" id="local-base-url" class="form-input" placeholder="http://localhost:11434/v1">
            <span class="form-hint">ä¾‹å¦‚: Ollama é»˜è®¤åœ°å€ä¸º http://localhost:11434/v1</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-model-name">æ¨¡å‹åç§°</label>
            <input type="text" id="local-model-name" class="form-input" placeholder="llama3">
            <span class="form-hint">ä¾‹å¦‚: llama3, qwen2, codellama</span>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="local-timeout">è¯·æ±‚è¶…æ—¶ (æ¯«ç§’)</label>
            <input type="number" id="local-timeout" class="form-input" value="120000">
            <span class="form-hint">å»ºè®®å€¼: 120000 (2åˆ†é’Ÿ)</span>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-primary" id="save-settings-btn">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    
    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chat-container');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const stopBtn = document.getElementById('stop-btn');
    const attachBtn = document.getElementById('attach-btn');
    const modelSelect = document.getElementById('model-select');
    const compileBtn = document.getElementById('compile-btn');
    const refreshBtn = document.getElementById('refresh-context');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const modeChatBtn = document.getElementById('mode-chat');
    const modeAgentBtn = document.getElementById('mode-agent');
    const fileChips = document.getElementById('file-chips');
    const attachmentsBar = document.getElementById('attachments-bar');
    
    // çŠ¶æ€å˜é‡
    let history = [];
    let currentMode = 'chat';
    let attachedFiles = [];
    let isGenerating = false;
    let currentAbortController = null;
    let activeSettingsTab = 'online';
    
    // ===== åˆå§‹åŒ–å‡½æ•° =====
    function init() {
      // è®¾ç½®é»˜è®¤æ¨¡å¼
      setMode('chat');
      
      // åŠ è½½ä¿å­˜çš„çŠ¶æ€
      const savedState = vscode.getState();
      if (savedState) {
        if (savedState.attachedFiles) {
          attachedFiles = savedState.attachedFiles;
          renderFileChips();
        }
        if (savedState.currentMode) {
          setMode(savedState.currentMode);
        }
      }
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      bindEvents();
      
      // è¯·æ±‚åˆå§‹ä¸Šä¸‹æ–‡
      vscode.postMessage({ type: 'refreshContext' });
      
      // éšè—é™„ä»¶æ ï¼ˆå¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼‰
      updateAttachmentsBar();
    }
    
    // ===== äº‹ä»¶ç»‘å®š =====
    function bindEvents() {
      // æ¨¡å¼åˆ‡æ¢
      modeChatBtn.addEventListener('click', () => setMode('chat'));
      modeAgentBtn.addEventListener('click', () => setMode('agent'));
      
      // å‘é€æ¶ˆæ¯
      sendBtn.addEventListener('click', sendMessage);
      stopBtn.addEventListener('click', stopGeneration);
      
      // è¾“å…¥å¤„ç†
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // æ–‡ä»¶é™„ä»¶
      attachBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'selectContextFiles' });
      });
      
      // ç¼–è¯‘æŒ‰é’®
      compileBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'compileCurrentFile' });
      });
      
      // åˆ·æ–°ä¸Šä¸‹æ–‡
      refreshBtn.addEventListener('click', () => {
        vscode.postMessage({ type: 'refreshContext' });
      });
      
      // è®¾ç½®æ¨¡æ€æ¡†
      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      saveSettingsBtn.addEventListener('click', saveSettings);
      
      // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          switchSettingsTab(tabId);
        });
      });
      
      // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°è®¾ç½®æ ‡ç­¾é¡µ
      modelSelect.addEventListener('change', (e) => {
        if (e.target.value === 'local') {
          switchSettingsTab('local');
        } else {
          switchSettingsTab('online');
        }
      });
      
      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
      
      // æ”¯æŒæ–‡ä»¶æ‹–æ‹½
      attachmentsBar.addEventListener('dragover', (e) => {
        e.preventDefault();
        attachmentsBar.style.backgroundColor = 'var(--vscode-list-hoverBackground)';
      });
      
      attachmentsBar.addEventListener('dragleave', () => {
        attachmentsBar.style.backgroundColor = '';
      });
      
      attachmentsBar.addEventListener('drop', (e) => {
        e.preventDefault();
        attachmentsBar.style.backgroundColor = '';
        
        const files = Array.from(e.dataTransfer.files);
        const fileInfos = files.map(file => ({
          name: file.name,
          path: file.path
        }));
        
        vscode.postMessage({
          type: 'filesSelected',
          files: fileInfos
        });
      });
      
      // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
      input.addEventListener('input', autoResizeTextarea);
    }
    
    // ===== è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦ =====
    function autoResizeTextarea() {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }
    
    // ===== æ¨¡å¼åˆ‡æ¢ =====
    function setMode(mode) {
      currentMode = mode;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      modeChatBtn.classList.remove('active');
      modeAgentBtn.classList.remove('active');
      
      const activeBtn = mode === 'chat' ? modeChatBtn : modeAgentBtn;
      activeBtn.classList.add('active');
      
      // æ›´æ–°è¾“å…¥æ¡†æç¤º
      input.placeholder = mode === 'agent' 
        ? "è¾“å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š'åˆ›å»º src/utils.ts' æˆ– 'å¦‚ä½•ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶'..." 
        : "è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–ä»£ç è¯·æ±‚... (Enter å‘é€, Shift+Enter æ¢è¡Œ)";
      
      // ä¿å­˜çŠ¶æ€
      saveState();
    }
    
    // ===== æ¶ˆæ¯å¤„ç† =====
    function sendMessage() {
      const text = input.value.trim();
      if (!text || isGenerating) return;
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessage(text, 'user');
      input.value = '';
      autoResizeTextarea(); // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
      
      // å¼€å§‹ç”ŸæˆçŠ¶æ€
      isGenerating = true;
      updateButtonState();
      
      // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
      showLoadingIndicator();
      
      // å‘é€æ¶ˆæ¯åˆ°æ‰©å±•
      vscode.postMessage({
        type: 'sendMessage',
        text: text,
        history: history,
        model: modelSelect.value,
        mode: currentMode,
        files: attachedFiles.map(f => f.path)
      });
      
      // æ·»åŠ åˆ°å†å²
      history.push({ role: 'user', content: text });
      
      // ä¿å­˜çŠ¶æ€
      saveState();
    }
    
    function stopGeneration() {
      if (!isGenerating) return;
      
      hideLoadingIndicator();
      
      addMessage('âš ï¸ ç”Ÿæˆå·²åœæ­¢', 'ai', true);
      isGenerating = false;
      updateButtonState();
    }
    
    // ===== ç•Œé¢æ›´æ–°å‡½æ•° =====
    function addMessage(text, type, isError = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      if (isError) {
        messageDiv.style.background = 'linear-gradient(135deg, var(--danger-color), #c0392b)';
        messageDiv.style.color = 'white';
      }
      
      // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
      const formattedContent = formatMessageContent(text, type);
      messageDiv.innerHTML = formattedContent;
      
      // æ·»åŠ æ—¶é—´æˆ³
      const timeSpan = document.createElement('div');
      timeSpan.className = 'message-time';
      timeSpan.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageDiv.appendChild(timeSpan);
      
      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }
    
    function formatMessageContent(text, type) {
      if (type === 'user') {
        return escapeHtml(text);
      }
      
      // AI æ¶ˆæ¯å¤„ç†
      let html = '';
      let lines = text.split('\n');
      let inCodeBlock = false;
      let currentLanguage = '';
      let buffer = '';
      
      // æ£€æµ‹æ–‡ä»¶æ“ä½œæ ‡è®°
      const fileActionMatch = text.match(/^> FILE:\s*(.+?)$/m);
      
      lines.forEach(line => {
        // æ£€æµ‹ä»£ç å—å¼€å§‹
        if (line.startsWith('```')) {
          if (!inCodeBlock) {
            // å¼€å§‹ä»£ç å—
            inCodeBlock = true;
            currentLanguage = line.substring(3).trim();
            html += buffer;
            buffer = '';
          } else {
            // ç»“æŸä»£ç å—
            html += `<div class="code-block">
              <div class="code-header">
                <span>${currentLanguage || 'code'}</span>
                <span class="language-tag">${currentLanguage || 'text'}</span>
              </div>
              <pre><code>${escapeHtml(buffer)}</code></pre>
            </div>`;
            buffer = '';
            inCodeBlock = false;
            currentLanguage = '';
          }
          return;
        }
        
        if (inCodeBlock) {
          buffer += line + '\n';
        } else {
          // å¤„ç†æ™®é€šæ–‡æœ¬
          if (line.trim().startsWith('> FILE:')) {
            const filePath = line.substring(7).trim();
            html += `<div class="file-action-card">
              <div class="file-header">
                <span class="file-icon">ğŸ“„</span>
                <span class="file-path">${escapeHtml(filePath)}</span>
              </div>
              <div class="action-buttons">
                <button class="btn-primary" onclick="applyFileChange('${escapeHtml(filePath)}')">
                  âš¡ï¸ å®¡æŸ¥å¹¶åº”ç”¨
                </button>
              </div>
            </div>`;
          } else if (line.trim()) {
            html += `<p>${escapeHtml(line)}</p>`;
          }
        }
      });
      
      // å¤„ç†å‰©ä½™çš„ç¼“å†²åŒºå†…å®¹
      if (buffer.trim()) {
        html += buffer;
      }
      
      return html;
    }
    
    function showLoadingIndicator() {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.id = 'loading-indicator';
      loadingDiv.innerHTML = `
        <div class="loading-dots">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
        <span>AI æ­£åœ¨æ€è€ƒ...</span>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom();
    }
    
    function hideLoadingIndicator() {
      const loading = document.getElementById('loading-indicator');
      if (loading) loading.remove();
    }
    
    function updateButtonState() {
      if (isGenerating) {
        sendBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        input.disabled = true;
      } else {
        sendBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        input.disabled = false;
        input.focus();
      }
    }
    
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // ===== æ–‡ä»¶é™„ä»¶ç®¡ç† =====
    function renderFileChips() {
      fileChips.innerHTML = '';
      
      attachedFiles.forEach((file, index) => {
        const chip = document.createElement('div');
        chip.className = 'file-chip';
        chip.title = file.path;
        
        chip.innerHTML = `
          <span>ğŸ“„ ${escapeHtml(file.name)}</span>
          <span class="remove-chip" data-index="${index}">Ã—</span>
        `;
        
        fileChips.appendChild(chip);
      });
      
      // æ·»åŠ åˆ é™¤äº‹ä»¶
      document.querySelectorAll('.remove-chip').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = parseInt(btn.dataset.index);
          attachedFiles.splice(index, 1);
          renderFileChips();
          updateAttachmentsBar();
          saveState();
        });
      });
    }
    
    function updateAttachmentsBar() {
      if (attachedFiles.length > 0) {
        attachmentsBar.style.display = 'flex';
      } else {
        attachmentsBar.style.display = 'none';
      }
    }
    
    // ===== è®¾ç½®ç®¡ç† =====
    function openSettings() {
      // æ ¹æ®å½“å‰é€‰æ‹©çš„æ¨¡å‹è®¾ç½®æ ‡ç­¾é¡µ
      if (modelSelect.value === 'local') {
        switchSettingsTab('local');
      } else {
        switchSettingsTab('online');
      }
      
      // è¯·æ±‚å½“å‰è®¾ç½®
      vscode.postMessage({ type: 'getSettings' });
      settingsModal.style.display = 'flex';
    }
    
    function closeSettings() {
      settingsModal.style.display = 'none';
    }
    
    function switchSettingsTab(tabId) {
      // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });
      
      // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
      document.getElementById('online-settings').style.display = 
        tabId === 'online' ? 'block' : 'none';
      document.getElementById('local-settings').style.display = 
        tabId === 'local' ? 'block' : 'none';
      
      activeSettingsTab = tabId;
    }
    
    function saveSettings() {
      const settings = {};
      
      if (activeSettingsTab === 'online') {
        settings.deepseekApiKey = document.getElementById('key-deepseek').value;
        settings.qwenApiKey = document.getElementById('key-qwen').value;
        settings.doubanApiKey = document.getElementById('key-douban').value;
      } else {
        settings.localModelEnabled = document.getElementById('local-enabled').checked;
        settings.localModelBaseUrl = document.getElementById('local-base-url').value;
        settings.localModelName = document.getElementById('local-model-name').value;
        settings.localModelTimeout = parseInt(document.getElementById('local-timeout').value) || 120000;
      }
      
      vscode.postMessage({
        type: 'saveSettings',
        settings: settings
      });
      
      closeSettings();
    }
    
    // ===== è¾…åŠ©å‡½æ•° =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function saveState() {
      vscode.setState({
        attachedFiles: attachedFiles,
        currentMode: currentMode
      });
    }
    
    // å…¨å±€å‡½æ•°ä¾›æŒ‰é’®ä½¿ç”¨
    window.applyFileChange = function(filePath) {
      // è¿™é‡Œéœ€è¦ä»ä»£ç å—ä¸­æå–å†…å®¹
      // ç®€åŒ–å®ç°ï¼šæç¤ºç”¨æˆ·
      vscode.postMessage({
        type: 'applyFileChange',
        filepath: filePath,
        content: '[éœ€è¦ä»ä»£ç å—ä¸­æå–å†…å®¹]'
      });
    };
    
    // ===== æ¶ˆæ¯ç›‘å¬å™¨ =====
    window.addEventListener('message', event => {
      const message = event.data;
      
      switch (message.type) {
        case 'addResponse':
          hideLoadingIndicator();
          addMessage(message.text, 'ai');
          history.push({ role: 'assistant', content: message.text });
          isGenerating = false;
          updateButtonState();
          break;
          
        case 'updateContextInfo':
          document.getElementById('context-text').textContent = message.text;
          break;
          
        case 'filesSelected':
          message.files.forEach(file => {
            if (!attachedFiles.some(f => f.path === file.path)) {
              attachedFiles.push(file);
            }
          });
          renderFileChips();
          updateAttachmentsBar();
          saveState();
          break;
          
        case 'updateSettings':
          // æ›´æ–°è¡¨å•å­—æ®µ
          if (message.settings.deepseekApiKey) {
            document.getElementById('key-deepseek').value = message.settings.deepseekApiKey;
          }
          if (message.settings.qwenApiKey) {
            document.getElementById('key-qwen').value = message.settings.qwenApiKey;
          }
          if (message.settings.doubanApiKey) {
            document.getElementById('key-douban').value = message.settings.doubanApiKey;
          }
          if (message.settings.localModelEnabled !== undefined) {
            document.getElementById('local-enabled').checked = message.settings.localModelEnabled;
          }
          if (message.settings.localModelBaseUrl) {
            document.getElementById('local-base-url').value = message.settings.localModelBaseUrl;
          }
          if (message.settings.localModelName) {
            document.getElementById('local-model-name').value = message.settings.localModelName;
          }
          if (message.settings.localModelTimeout) {
            document.getElementById('local-timeout').value = message.settings.localModelTimeout;
          }
          break;
      }
    });
    
    // åˆå§‹åŒ–åº”ç”¨
    init();
  </script>
</body>
</html>